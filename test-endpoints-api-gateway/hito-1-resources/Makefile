# HITO 1 - RESOURCES CORE MAKEFILE
# Tests para gesti√≥n de recursos, categor√≠as, programas y mantenimiento

.PHONY: help test-all test-crud test-categories test-programs test-import-export test-maintenance results clean
.DEFAULT_GOAL := help

# Variables de configuraci√≥n
NODE_VERSION := 22.15.0
HITO_DIR := hito-1-resources
RESULTS_DIR := ./results
NVM_SCRIPT := source ~/.nvm/nvm.sh && nvm use $(NODE_VERSION)

# Colores para output
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
BLUE := \033[0;34m
MAGENTA := \033[0;35m
CYAN := \033[0;36m
WHITE := \033[1;37m
NC := \033[0m # No Color

help: ## Mostrar ayuda de comandos disponibles para Hito 1
	@echo "$(CYAN)HITO 1 - RESOURCES CORE TESTING$(NC)"
	@echo "$(WHITE)Tests para gesti√≥n de recursos, categor√≠as, programas y mantenimiento$(NC)"
	@echo ""
	@echo "$(YELLOW)Comandos disponibles:$(NC)"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  $(GREEN)%-20s$(NC) %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""

# ================================
# TESTS INDIVIDUALES
# ================================

test-crud: ## Ejecutar tests CRUD de recursos
	@echo "$(BLUE)Ejecutando tests CRUD de recursos...$(NC)"
	@mkdir -p $(RESULTS_DIR)
	@$(NVM_SCRIPT) && node ./crud-resources.js > $(RESULTS_DIR)/crud-resources-$(shell date +%Y%m%d_%H%M%S).md 2>&1
	@echo "$(GREEN)‚úì Tests CRUD completados$(NC)"

test-categories: ## Ejecutar tests de gesti√≥n de categor√≠as
	@echo "$(BLUE)Ejecutando tests de categor√≠as...$(NC)"
	@mkdir -p $(RESULTS_DIR)
	@$(NVM_SCRIPT) && node $(HITO_DIR)/manage-categories.js > $(RESULTS_DIR)/manage-categories-$(shell date +%Y%m%d_%H%M%S).md 2>&1
	@echo "$(GREEN)‚úì Tests de categor√≠as completados$(NC)"

test-programs: ## Ejecutar tests de gesti√≥n de programas acad√©micos
	@echo "$(BLUE)Ejecutando tests de programas acad√©micos...$(NC)"
	@mkdir -p $(RESULTS_DIR)
	@$(NVM_SCRIPT) && node $(HITO_DIR)/manage-programs.js > $(RESULTS_DIR)/manage-programs-$(shell date +%Y%m%d_%H%M%S).md 2>&1
	@echo "$(GREEN)‚úì Tests de programas completados$(NC)"

test-import-export: ## Ejecutar tests de importaci√≥n y exportaci√≥n
	@echo "$(BLUE)Ejecutando tests de import/export...$(NC)"
	@mkdir -p $(RESULTS_DIR)
	@$(NVM_SCRIPT) && node $(HITO_DIR)/import-export.js > $(RESULTS_DIR)/import-export-$(shell date +%Y%m%d_%H%M%S).md 2>&1
	@echo "$(GREEN)‚úì Tests de import/export completados$(NC)"

test-maintenance: ## Ejecutar tests de mantenimiento de recursos
	@echo "$(BLUE)Ejecutando tests de mantenimiento...$(NC)"
	@mkdir -p $(RESULTS_DIR)
	@$(NVM_SCRIPT) && node $(HITO_DIR)/maintenance.js > $(RESULTS_DIR)/maintenance-$(shell date +%Y%m%d_%H%M%S).md 2>&1
	@echo "$(GREEN)‚úì Tests de mantenimiento completados$(NC)"

# ================================
# TESTS COMBINADOS
# ================================

test-all: test-crud test-categories test-programs test-import-export test-maintenance ## Ejecutar todos los tests del Hito 1
	@echo "$(MAGENTA)üéâ Todos los tests del Hito 1 completados$(NC)"
	@echo "$(WHITE)Resultados guardados en: $(RESULTS_DIR)$(NC)"

test-core: test-crud test-categories test-programs ## Ejecutar tests core (sin import/export ni mantenimiento)
	@echo "$(GREEN)‚úì Tests core del Hito 1 completados$(NC)"

test-advanced: test-import-export test-maintenance ## Ejecutar tests avanzados (import/export y mantenimiento)
	@echo "$(GREEN)‚úì Tests avanzados del Hito 1 completados$(NC)"

# ================================
# RESULTADOS Y REPORTES
# ================================

results: ## Ver resumen de resultados de tests
	@echo "$(CYAN)üìä RESULTADOS HITO 1 - RESOURCES CORE$(NC)"
	@if [ -d "$(RESULTS_DIR)" ]; then \
		echo "$(WHITE)Archivos de resultados encontrados:$(NC)"; \
		find $(RESULTS_DIR) -name "*.md" -type f -exec echo "  $(GREEN)‚úì$(NC) {}" \; | sort; \
		echo ""; \
		echo "$(YELLOW)√öltimos 3 resultados:$(NC)"; \
		find $(RESULTS_DIR) -name "*.md" -type f -exec ls -la {} \; | sort -k9 | tail -3; \
	else \
		echo "$(RED)‚ùå No hay resultados disponibles$(NC)"; \
		echo "$(WHITE)Ejecute 'make test-all' para generar resultados$(NC)"; \
	fi

results-crud: ## Ver resultados espec√≠ficos de tests CRUD
	@echo "$(CYAN)üìã Resultados CRUD Resources$(NC)"
	@find $(RESULTS_DIR) -name "crud-resources-*.md" -type f -exec echo "$(GREEN)‚úì$(NC) {}" \; | head -5

results-categories: ## Ver resultados espec√≠ficos de tests de categor√≠as
	@echo "$(CYAN)üìã Resultados Manage Categories$(NC)"
	@find $(RESULTS_DIR) -name "manage-categories-*.md" -type f -exec echo "$(GREEN)‚úì$(NC) {}" \; | head -5

results-programs: ## Ver resultados espec√≠ficos de tests de programas
	@echo "$(CYAN)üìã Resultados Manage Programs$(NC)"
	@find $(RESULTS_DIR) -name "manage-programs-*.md" -type f -exec echo "$(GREEN)‚úì$(NC) {}" \; | head -5

results-import-export: ## Ver resultados espec√≠ficos de tests import/export
	@echo "$(CYAN)üìã Resultados Import/Export$(NC)"
	@find $(RESULTS_DIR) -name "import-export-*.md" -type f -exec echo "$(GREEN)‚úì$(NC) {}" \; | head -5

results-maintenance: ## Ver resultados espec√≠ficos de tests de mantenimiento
	@echo "$(CYAN)üìã Resultados Maintenance$(NC)"
	@find $(RESULTS_DIR) -name "maintenance-*.md" -type f -exec echo "$(GREEN)‚úì$(NC) {}" \; | head -5

# ================================
# UTILIDADES
# ================================

clean: ## Limpiar archivos de resultados
	@echo "$(YELLOW)üßπ Limpiando resultados del Hito 1...$(NC)"
	@rm -rf $(RESULTS_DIR)
	@echo "$(GREEN)‚úì Resultados limpiados$(NC)"

status: ## Mostrar estado actual del Hito 1
	@echo "$(CYAN)üìä ESTADO HITO 1 - RESOURCES CORE$(NC)"
	@echo "$(WHITE)Directorio: $(HITO_DIR)$(NC)"
	@echo "$(WHITE)Resultados: $(RESULTS_DIR)$(NC)"
	@echo ""
	@echo "$(YELLOW)Archivos de test disponibles:$(NC)"
	@ls -la $(HITO_DIR)/*.js 2>/dev/null | awk '{print "  $(GREEN)‚úì$(NC) " $$9}' || echo "  $(RED)‚ùå No hay archivos de test$(NC)"
	@echo ""
	@if [ -d "$(RESULTS_DIR)" ]; then \
		echo "$(YELLOW)Total de resultados: $(NC)$$(find $(RESULTS_DIR) -name "*.md" | wc -l)"; \
	else \
		echo "$(YELLOW)Total de resultados: $(NC)0"; \
	fi

info: ## Mostrar informaci√≥n del Hito 1
	@echo "$(CYAN)‚ÑπÔ∏è  INFORMACI√ìN HITO 1 - RESOURCES CORE$(NC)"
	@echo "$(WHITE)Descripci√≥n: Tests para gesti√≥n completa de recursos$(NC)"
	@echo "$(WHITE)Flujos incluidos:$(NC)"
	@echo "  $(GREEN)‚Ä¢$(NC) CRUD de recursos"
	@echo "  $(GREEN)‚Ä¢$(NC) Gesti√≥n de categor√≠as"
	@echo "  $(GREEN)‚Ä¢$(NC) Gesti√≥n de programas acad√©micos"
	@echo "  $(GREEN)‚Ä¢$(NC) Importaci√≥n y exportaci√≥n"
	@echo "  $(GREEN)‚Ä¢$(NC) Mantenimiento de recursos"
	@echo ""
	@echo "$(WHITE)Endpoints principales:$(NC)"
	@echo "  $(GREEN)‚Ä¢$(NC) GET/POST/PUT/DELETE /api/v1/resources"
	@echo "  $(GREEN)‚Ä¢$(NC) GET/POST/PUT/DELETE /api/v1/resources/resource-categories"
	@echo "  $(GREEN)‚Ä¢$(NC) GET/POST/PUT/DELETE /api/v1/resources/programs"
	@echo "  $(GREEN)‚Ä¢$(NC) POST /api/v1/resources/import/csv"
	@echo "  $(GREEN)‚Ä¢$(NC) GET /api/v1/resources/export/template"

# Configuraci√≥n de Make
SHELL := /bin/bash
.SHELLFLAGS := -eu -o pipefail -c
