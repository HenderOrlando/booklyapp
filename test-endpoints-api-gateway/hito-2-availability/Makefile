# HITO 2 - AVAILABILITY CORE MAKEFILE
# Tests para disponibilidad, reservas, b√∫squedas y calendarios

.PHONY: help test-all test-basic test-search test-calendar test-reassignment test-tracking results clean
.DEFAULT_GOAL := help

# Variables de configuraci√≥n
NODE_VERSION := 22.15.0
HITO_DIR := hito-2-availability
RESULTS_DIR := $(HITO_DIR)/results
NVM_SCRIPT := source ~/.nvm/nvm.sh && nvm use $(NODE_VERSION)

# Colores para output
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
BLUE := \033[0;34m
MAGENTA := \033[0;35m
CYAN := \033[0;36m
WHITE := \033[1;37m
NC := \033[0m # No Color

help: ## Mostrar ayuda de comandos disponibles para Hito 2
	@echo "$(CYAN)HITO 2 - AVAILABILITY CORE TESTING$(NC)"
	@echo "$(WHITE)Tests para disponibilidad, reservas, b√∫squedas y calendarios$(NC)"
	@echo ""
	@echo "$(YELLOW)Comandos disponibles:$(NC)"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  $(GREEN)%-20s$(NC) %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""

# ================================
# TESTS INDIVIDUALES
# ================================

test-basic: ## Ejecutar tests de disponibilidad b√°sica
	@echo "$(BLUE)Ejecutando tests de disponibilidad b√°sica...$(NC)"
	@mkdir -p $(RESULTS_DIR)
	@$(NVM_SCRIPT) && node $(HITO_DIR)/basic-availability.js > $(RESULTS_DIR)/basic-availability-$(shell date +%Y%m%d_%H%M%S).md 2>&1
	@echo "$(GREEN)‚úì Tests de disponibilidad b√°sica completados$(NC)"

test-search: ## Ejecutar tests de b√∫squeda avanzada
	@echo "$(BLUE)Ejecutando tests de b√∫squeda avanzada...$(NC)"
	@mkdir -p $(RESULTS_DIR)
	@$(NVM_SCRIPT) && node $(HITO_DIR)/advanced-search.js > $(RESULTS_DIR)/advanced-search-$(shell date +%Y%m%d_%H%M%S).md 2>&1
	@echo "$(GREEN)‚úì Tests de b√∫squeda avanzada completados$(NC)"

test-calendar: ## Ejecutar tests de integraci√≥n con calendario
	@echo "$(BLUE)Ejecutando tests de integraci√≥n con calendario...$(NC)"
	@mkdir -p $(RESULTS_DIR)
	@$(NVM_SCRIPT) && node $(HITO_DIR)/calendar-integration.js > $(RESULTS_DIR)/calendar-integration-$(shell date +%Y%m%d_%H%M%S).md 2>&1
	@echo "$(GREEN)‚úì Tests de calendario completados$(NC)"

test-reassignment: ## Ejecutar tests de sistema de reasignaci√≥n
	@echo "$(BLUE)Ejecutando tests de sistema de reasignaci√≥n...$(NC)"
	@mkdir -p $(RESULTS_DIR)
	@$(NVM_SCRIPT) && node $(HITO_DIR)/reassignment-system.js > $(RESULTS_DIR)/reassignment-system-$(shell date +%Y%m%d_%H%M%S).md 2>&1
	@echo "$(GREEN)‚úì Tests de reasignaci√≥n completados$(NC)"

test-tracking: ## Ejecutar tests de seguimiento de uso
	@echo "$(BLUE)Ejecutando tests de seguimiento de uso...$(NC)"
	@mkdir -p $(RESULTS_DIR)
	@$(NVM_SCRIPT) && node $(HITO_DIR)/usage-tracking.js > $(RESULTS_DIR)/usage-tracking-$(shell date +%Y%m%d_%H%M%S).md 2>&1
	@echo "$(GREEN)‚úì Tests de seguimiento completados$(NC)"

# ================================
# TESTS COMBINADOS
# ================================

test-all: test-basic test-search test-calendar test-reassignment test-tracking ## Ejecutar todos los tests del Hito 2
	@echo "$(MAGENTA)üéâ Todos los tests del Hito 2 completados$(NC)"
	@echo "$(WHITE)Resultados guardados en: $(RESULTS_DIR)$(NC)"

test-core: test-basic test-search ## Ejecutar tests core (disponibilidad b√°sica y b√∫squeda)
	@echo "$(GREEN)‚úì Tests core del Hito 2 completados$(NC)"

test-advanced: test-calendar test-reassignment test-tracking ## Ejecutar tests avanzados (calendario, reasignaci√≥n, seguimiento)
	@echo "$(GREEN)‚úì Tests avanzados del Hito 2 completados$(NC)"

test-integration: test-calendar test-tracking ## Ejecutar tests de integraci√≥n (calendario y seguimiento)
	@echo "$(GREEN)‚úì Tests de integraci√≥n del Hito 2 completados$(NC)"

# ================================
# RESULTADOS Y REPORTES
# ================================

results: ## Ver resumen de resultados de tests
	@echo "$(CYAN)üìä RESULTADOS HITO 2 - AVAILABILITY CORE$(NC)"
	@if [ -d "$(RESULTS_DIR)" ]; then \
		echo "$(WHITE)Archivos de resultados encontrados:$(NC)"; \
		find $(RESULTS_DIR) -name "*.md" -type f -exec echo "  $(GREEN)‚úì$(NC) {}" \; | sort; \
		echo ""; \
		echo "$(YELLOW)√öltimos 3 resultados:$(NC)"; \
		find $(RESULTS_DIR) -name "*.md" -type f -exec ls -la {} \; | sort -k9 | tail -3; \
	else \
		echo "$(RED)‚ùå No hay resultados disponibles$(NC)"; \
		echo "$(WHITE)Ejecute 'make test-all' para generar resultados$(NC)"; \
	fi

results-basic: ## Ver resultados espec√≠ficos de tests de disponibilidad b√°sica
	@echo "$(CYAN)üìã Resultados Basic Availability$(NC)"
	@find $(RESULTS_DIR) -name "basic-availability-*.md" -type f -exec echo "$(GREEN)‚úì$(NC) {}" \; | head -5

results-search: ## Ver resultados espec√≠ficos de tests de b√∫squeda avanzada
	@echo "$(CYAN)üìã Resultados Advanced Search$(NC)"
	@find $(RESULTS_DIR) -name "advanced-search-*.md" -type f -exec echo "$(GREEN)‚úì$(NC) {}" \; | head -5

results-calendar: ## Ver resultados espec√≠ficos de tests de calendario
	@echo "$(CYAN)üìã Resultados Calendar Integration$(NC)"
	@find $(RESULTS_DIR) -name "calendar-integration-*.md" -type f -exec echo "$(GREEN)‚úì$(NC) {}" \; | head -5

results-reassignment: ## Ver resultados espec√≠ficos de tests de reasignaci√≥n
	@echo "$(CYAN)üìã Resultados Reassignment System$(NC)"
	@find $(RESULTS_DIR) -name "reassignment-system-*.md" -type f -exec echo "$(GREEN)‚úì$(NC) {}" \; | head -5

results-tracking: ## Ver resultados espec√≠ficos de tests de seguimiento
	@echo "$(CYAN)üìã Resultados Usage Tracking$(NC)"
	@find $(RESULTS_DIR) -name "usage-tracking-*.md" -type f -exec echo "$(GREEN)‚úì$(NC) {}" \; | head -5

# ================================
# UTILIDADES
# ================================

clean: ## Limpiar archivos de resultados
	@echo "$(YELLOW)üßπ Limpiando resultados del Hito 2...$(NC)"
	@rm -rf $(RESULTS_DIR)
	@echo "$(GREEN)‚úì Resultados limpiados$(NC)"

status: ## Mostrar estado actual del Hito 2
	@echo "$(CYAN)üìä ESTADO HITO 2 - AVAILABILITY CORE$(NC)"
	@echo "$(WHITE)Directorio: $(HITO_DIR)$(NC)"
	@echo "$(WHITE)Resultados: $(RESULTS_DIR)$(NC)"
	@echo ""
	@echo "$(YELLOW)Archivos de test disponibles:$(NC)"
	@ls -la $(HITO_DIR)/*.js 2>/dev/null | awk '{print "  $(GREEN)‚úì$(NC) " $$9}' || echo "  $(RED)‚ùå No hay archivos de test$(NC)"
	@echo ""
	@if [ -d "$(RESULTS_DIR)" ]; then \
		echo "$(YELLOW)Total de resultados: $(NC)$$(find $(RESULTS_DIR) -name "*.md" | wc -l)"; \
	else \
		echo "$(YELLOW)Total de resultados: $(NC)0"; \
	fi

info: ## Mostrar informaci√≥n del Hito 2
	@echo "$(CYAN)‚ÑπÔ∏è  INFORMACI√ìN HITO 2 - AVAILABILITY CORE$(NC)"
	@echo "$(WHITE)Descripci√≥n: Tests para disponibilidad y reservas$(NC)"
	@echo "$(WHITE)Flujos incluidos:$(NC)"
	@echo "  $(GREEN)‚Ä¢$(NC) Disponibilidad b√°sica"
	@echo "  $(GREEN)‚Ä¢$(NC) B√∫squeda avanzada"
	@echo "  $(GREEN)‚Ä¢$(NC) Integraci√≥n con calendario"
	@echo "  $(GREEN)‚Ä¢$(NC) Sistema de reasignaci√≥n"
	@echo "  $(GREEN)‚Ä¢$(NC) Seguimiento de uso"
	@echo ""
	@echo "$(WHITE)Endpoints principales:$(NC)"
	@echo "  $(GREEN)‚Ä¢$(NC) GET /api/v1/availability/basic"
	@echo "  $(GREEN)‚Ä¢$(NC) GET /api/v1/availability/search"
	@echo "  $(GREEN)‚Ä¢$(NC) GET/POST /api/v1/availability/calendar"
	@echo "  $(GREEN)‚Ä¢$(NC) GET/POST/PUT /api/v1/availability/reservations"
	@echo "  $(GREEN)‚Ä¢$(NC) GET/POST /api/v1/availability/reassignment-requests"

# Configuraci√≥n de Make
SHELL := /bin/bash
.SHELLFLAGS := -eu -o pipefail -c
