# ===============================================
# Bookly Mock - Makefile
# ===============================================

.PHONY: help install setup dev build clean docker-up docker-down docker-logs seed

help: ## Mostrar ayuda
	@echo "Bookly Mock - Comandos Disponibles:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

# ===============================================
# INSTALACI√ìN Y SETUP
# ===============================================

install: ## Instalar dependencias
	npm install

setup: ## Setup inicial completo (install + docker + seeds)
	@echo "üöÄ Iniciando setup de Bookly Mock..."
	$(MAKE) install
	$(MAKE) docker-up
	@echo "‚è≥ Esperando a que la infraestructura est√© lista..."
	sleep 30
	$(MAKE) seed
	@echo "‚úÖ Setup completado!"

# ===============================================
# DESARROLLO
# ===============================================

dev: ## Iniciar todos los servicios en modo desarrollo
	npm run start:dev

dev-auth: ## Iniciar solo auth-service
	npm run start:dev -- --project auth-service

dev-resources: ## Iniciar solo resources-service
	npm run start:dev -- --project resources-service

dev-availability: ## Iniciar solo availability-service
	npm run start:dev -- --project availability-service

dev-stockpile: ## Iniciar solo stockpile-service
	npm run start:dev -- --project stockpile-service

dev-reports: ## Iniciar solo reports-service
	npm run start:dev -- --project reports-service

dev-gateway: ## Iniciar solo api-gateway
	npm run start:dev -- --project api-gateway

# ===============================================
# BUILD
# ===============================================

build: ## Build de todos los servicios
	npm run build

build-auth: ## Build auth-service
	npm run build -- auth-service

build-resources: ## Build resources-service
	npm run build -- resources-service

build-availability: ## Build availability-service
	npm run build -- availability-service

build-stockpile: ## Build stockpile-service
	npm run build -- stockpile-service

build-reports: ## Build reports-service
	npm run build -- reports-service

build-gateway: ## Build api-gateway
	npm run build -- api-gateway

# ===============================================
# DOCKER
# ===============================================

docker-up: ## Iniciar infraestructura Docker (MongoDB, Kafka, Redis)
	@echo "üê≥ Iniciando infraestructura..."
	docker-compose up -d
	@echo "‚úÖ Infraestructura iniciada"

docker-down: ## Detener infraestructura Docker
	@echo "üõë Deteniendo infraestructura..."
	docker-compose down
	@echo "‚úÖ Infraestructura detenida"

docker-clean: ## Limpiar vol√∫menes Docker (CUIDADO: borra datos)
	@echo "‚ö†Ô∏è  Limpiando vol√∫menes Docker..."
	docker-compose down -v
	@echo "‚úÖ Vol√∫menes limpiados"

docker-logs: ## Ver logs de todos los contenedores
	docker-compose logs -f

docker-logs-kafka: ## Ver logs de Kafka
	docker-compose logs -f kafka

docker-logs-redis: ## Ver logs de Redis
	docker-compose logs -f redis

docker-logs-mongo-auth: ## Ver logs de MongoDB Auth
	docker-compose logs -f mongodb-auth

docker-logs-mongo-resources: ## Ver logs de MongoDB Resources
	docker-compose logs -f mongodb-resources

docker-status: ## Ver estado de contenedores
	docker-compose ps

# ===============================================
# BASE DE DATOS
# ===============================================

seed: ## Ejecutar seeds en todas las bases de datos
	@echo "üå± Ejecutando seeds..."
	npm run seed:all
	@echo "‚úÖ Seeds completados"

seed-auth: ## Ejecutar seed de auth-service
	npm run seed:auth

seed-resources: ## Ejecutar seed de resources-service
	npm run seed:resources

seed-availability: ## Ejecutar seed de availability-service
	npm run seed:availability

seed-stockpile: ## Ejecutar seed de stockpile-service
	npm run seed:stockpile

seed-reports: ## Ejecutar seed de reports-service
	npm run seed:reports

# ===============================================
# TESTING
# ===============================================

test: ## Ejecutar tests
	npm test

test-watch: ## Ejecutar tests en modo watch
	npm run test:watch

test-cov: ## Ejecutar tests con cobertura
	npm run test:cov

test-e2e: ## Ejecutar tests e2e
	npm run test:e2e

# ===============================================
# C√ìDIGO
# ===============================================

lint: ## Ejecutar linter
	npm run lint

format: ## Formatear c√≥digo
	npm run format

# ===============================================
# LIMPIEZA
# ===============================================

clean: ## Limpiar archivos generados
	@echo "üßπ Limpiando archivos generados..."
	rm -rf dist
	rm -rf node_modules
	rm -rf coverage
	@echo "‚úÖ Limpieza completada"

# ===============================================
# UTILIDADES
# ===============================================

status: ## Ver estado general del proyecto
	@echo "üìä Estado de Bookly Mock"
	@echo "========================"
	@echo ""
	@echo "Docker Containers:"
	@docker-compose ps || echo "Docker no est√° corriendo"
	@echo ""
	@echo "Puertos en uso:"
	@lsof -i :3000 -i :3001 -i :3002 -i :3003 -i :3004 -i :3005 -i :6379 -i :9092 2>/dev/null || echo "Ning√∫n puerto en uso"

health: ## Verificar health de servicios
	@echo "üè• Health Check"
	@echo "==============="
	@echo ""
	@echo "MongoDB Auth:"
	@docker exec bookly-mock-mongodb-auth mongosh --eval "db.runCommand('ping')" --quiet 2>/dev/null || echo "‚ùå No disponible"
	@echo ""
	@echo "Redis:"
	@docker exec bookly-mock-redis redis-cli ping 2>/dev/null || echo "‚ùå No disponible"
	@echo ""
	@echo "Kafka:"
	@docker exec bookly-mock-kafka kafka-broker-api-versions --bootstrap-server localhost:9093 2>/dev/null | grep -q "ApiVersion" && echo "‚úÖ OK" || echo "‚ùå No disponible"

urls: ## Mostrar URLs de servicios
	@echo "üåê URLs de Servicios"
	@echo "===================="
	@echo ""
	@echo "API Gateway:          http://localhost:3000/api/v1"
	@echo "Gateway Swagger:      http://localhost:3000/api/docs"
	@echo ""
	@echo "Auth Service:         http://localhost:3001/api/v1/auth"
	@echo "Auth Swagger:         http://localhost:3001/api/docs"
	@echo ""
	@echo "Resources Service:    http://localhost:3002/api/v1/resources"
	@echo "Resources Swagger:    http://localhost:3002/api/docs"
	@echo ""
	@echo "Availability Service: http://localhost:3003/api/v1/availability"
	@echo "Availability Swagger: http://localhost:3003/api/docs"
	@echo ""
	@echo "Stockpile Service:    http://localhost:3004/api/v1/stockpile"
	@echo "Stockpile Swagger:    http://localhost:3004/api/docs"
	@echo ""
	@echo "Reports Service:      http://localhost:3005/api/v1/reports"
	@echo "Reports Swagger:      http://localhost:3005/api/docs"

restart: ## Reiniciar todo (docker + servicios)
	@echo "üîÑ Reiniciando Bookly Mock..."
	$(MAKE) docker-down
	$(MAKE) docker-up
	sleep 10
	@echo "‚úÖ Reinicio completado"

reset: ## Reset completo (clean + setup)
	@echo "‚ö†Ô∏è  Reseteando Bookly Mock (esto borrar√° todos los datos)..."
	@read -p "¬øEst√°s seguro? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		$(MAKE) docker-clean; \
		$(MAKE) clean; \
		$(MAKE) setup; \
	fi

# ===============================================
# PRODUCCI√ìN
# ===============================================

prod-start: ## Iniciar todos los servicios en modo producci√≥n
	@echo "üöÄ Iniciando servicios en modo producci√≥n..."
	./start-all-prod.sh

prod-stop: ## Detener todos los servicios
	@echo "üõë Deteniendo servicios..."
	pkill -f 'node dist' || echo "No hay servicios corriendo"
	@echo "‚úÖ Servicios detenidos"

prod-restart: ## Reiniciar servicios en modo producci√≥n
	@echo "üîÑ Reiniciando servicios..."
	$(MAKE) prod-stop
	sleep 2
	$(MAKE) build
	$(MAKE) prod-start

prod-health: ## Verificar health de servicios en producci√≥n
	@echo "üè• Health Check de Servicios"
	@echo "============================"
	@echo ""
	@echo "API Gateway (3000):"
	@curl -s http://localhost:3000/health | jq -c '{service, status}' 2>/dev/null || echo "‚ùå No disponible"
	@echo ""
	@echo "Auth Service (3001):"
	@curl -s http://localhost:3001/api/v1/health | jq -c '{service, status}' 2>/dev/null || echo "‚ùå No disponible"
	@echo ""
	@echo "Resources Service (3002):"
	@curl -s http://localhost:3002/api/v1/health | jq -c '{service, status}' 2>/dev/null || echo "‚ùå No disponible"
	@echo ""
	@echo "Availability Service (3003):"
	@curl -s http://localhost:3003/api/v1/health | jq -c '{service, status}' 2>/dev/null || echo "‚ùå No disponible"
	@echo ""
	@echo "Stockpile Service (3004):"
	@curl -s http://localhost:3004/api/v1/health | jq -c '{service, status}' 2>/dev/null || echo "‚ùå No disponible"
	@echo ""
	@echo "Reports Service (3005):"
	@curl -s http://localhost:3005/api/v1/health | jq -c '{service, status}' 2>/dev/null || echo "‚ùå No disponible"

prod-logs: ## Ver logs de servicios en producci√≥n
	@echo "üìù Logs de Servicios (usa Ctrl+C para salir de cada log)"
	@echo ""
	@echo "Selecciona el servicio:"
	@echo "  1) API Gateway"
	@echo "  2) Auth Service"
	@echo "  3) Resources Service"
	@echo "  4) Availability Service"
	@echo "  5) Stockpile Service"
	@echo "  6) Reports Service"
	@echo "  7) Todos (tail -f)"
	@read -p "Opci√≥n [1-7]: " opt; \
	case $$opt in \
		1) tail -f /tmp/bookly-gateway.log ;; \
		2) tail -f /tmp/bookly-auth.log ;; \
		3) tail -f /tmp/bookly-resources.log ;; \
		4) tail -f /tmp/bookly-availability.log ;; \
		5) tail -f /tmp/bookly-stockpile.log ;; \
		6) tail -f /tmp/bookly-reports.log ;; \
		7) tail -f /tmp/bookly-*.log ;; \
		*) echo "Opci√≥n inv√°lida" ;; \
	esac

# ===============================================
# DESARROLLO R√ÅPIDO
# ===============================================

quick-start: docker-up ## Inicio r√°pido (solo infraestructura)
	@echo "‚úÖ Infraestructura lista. Ejecuta 'make dev' para iniciar servicios."

full-start: setup dev ## Inicio completo (setup + dev)

prod-full: ## Setup completo + inicio en producci√≥n
	@echo "üöÄ Setup y arranque completo en modo producci√≥n..."
	$(MAKE) docker-up
	@echo "‚è≥ Esperando infraestructura..."
	sleep 15
	$(MAKE) build
	$(MAKE) prod-start
	@echo ""
	@echo "‚úÖ Sistema completo iniciado!"
	@echo "Ejecuta 'make prod-health' para verificar el estado"

# ===============================================
# DEFAULT
# ===============================================

.DEFAULT_GOAL := help
