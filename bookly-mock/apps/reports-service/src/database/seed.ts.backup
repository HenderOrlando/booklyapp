import { createLogger } from "@libs/common";
import { NestFactory } from "@nestjs/core";
import { getModelToken } from "@nestjs/mongoose";
import { Model } from "mongoose";
import {
  UnsatisfiedDemand,
  UsageStatistic,
  UserEvaluation,
  UserFeedback,
} from "../infrastructure/schemas";
import { ReportsModule } from "../reports.module";

const logger = createLogger("ReportsSeed");

/**
 * Seed data para Reports Service
 * Crea feedback, evaluaciones, estad√≠sticas de uso y demanda insatisfecha
 */
async function seed() {
  try {
    logger.info("üå± Iniciando seed de Reports Service...");

    const app = await NestFactory.createApplicationContext(ReportsModule);
    const userFeedbackModel = app.get<Model<UserFeedback>>(
      getModelToken(UserFeedback.name)
    );
    const userEvaluationModel = app.get<Model<UserEvaluation>>(
      getModelToken(UserEvaluation.name)
    );
    const usageStatisticModel = app.get<Model<UsageStatistic>>(
      getModelToken(UsageStatistic.name)
    );
    const unsatisfiedDemandModel = app.get<Model<UnsatisfiedDemand>>(
      getModelToken(UnsatisfiedDemand.name)
    );

    // Limpiar datos existentes (solo en desarrollo)
    if (process.env.NODE_ENV === "development") {
      logger.info("Limpiando datos existentes...");
      await userFeedbackModel.deleteMany({});
      await userEvaluationModel.deleteMany({});
      await usageStatisticModel.deleteMany({});
      await unsatisfiedDemandModel.deleteMany({});
    }

    // Feedback de usuarios (RF-34)
    const today = new Date();
    const lastWeek = new Date(today);
    lastWeek.setDate(lastWeek.getDate() - 7);
    const lastMonth = new Date(today);
    lastMonth.setMonth(lastMonth.getMonth() - 1);

    const userFeedback = [
      {
        userId: "docente@ufps.edu.co",
        userName: "Juan Docente",
        reservationId: "reservation-001",
        resourceId: "auditorio-principal",
        resourceName: "Auditorio Principal",
        rating: 5,
        comment:
          "Excelente espacio, muy bien equipado. El sistema de sonido funcion√≥ perfectamente.",
        category: "facilities",
        wasIssueReported: false,
        createdAt: new Date(lastWeek.setHours(13, 0, 0)),
        createdBy: "docente@ufps.edu.co",
      },
      {
        userId: "estudiante@ufps.edu.co",
        userName: "Mar√≠a Estudiante",
        reservationId: "reservation-002",
        resourceId: "laboratorio-sistemas-1",
        resourceName: "Laboratorio de Sistemas 1",
        rating: 4,
        comment:
          "Buen laboratorio, pero algunos computadores est√°n lentos. Podr√≠a mejorar el mantenimiento.",
        category: "equipment",
        wasIssueReported: true,
        issueDescription: "3 computadores con rendimiento bajo",
        createdAt: new Date(lastWeek.setDate(lastWeek.getDate() - 3)),
        createdBy: "estudiante@ufps.edu.co",
      },
      {
        userId: "admin.sistemas@ufps.edu.co",
        userName: "Admin Sistemas",
        reservationId: "reservation-003",
        resourceId: "sala-conferencias-a",
        resourceName: "Sala de Conferencias A",
        rating: 5,
        comment:
          "Perfecta para reuniones peque√±as. La videoconferencia funciona muy bien.",
        category: "service",
        wasIssueReported: false,
        createdAt: new Date(lastWeek.setDate(lastWeek.getDate() - 5)),
        createdBy: "admin.sistemas@ufps.edu.co",
      },
      {
        userId: "docente@ufps.edu.co",
        userName: "Juan Docente",
        reservationId: "reservation-cancelled-001",
        resourceId: "proyector-portatil-1",
        resourceName: "Proyector Port√°til 1",
        rating: 3,
        comment:
          "El proceso de pr√©stamo es muy lento. Deber√≠an agilizar las aprobaciones.",
        category: "process",
        wasIssueReported: false,
        createdAt: new Date(lastMonth.setDate(lastMonth.getDate() + 10)),
        createdBy: "docente@ufps.edu.co",
      },
      {
        userId: "staff@ufps.edu.co",
        userName: "Ana Staff",
        reservationId: "reservation-005",
        resourceId: "auditorio-principal",
        resourceName: "Auditorio Principal",
        rating: 5,
        comment:
          "Excelente espacio para capacitaciones. Todo funcion√≥ perfectamente.",
        category: "overall",
        wasIssueReported: false,
        createdAt: new Date(lastMonth.setDate(lastMonth.getDate() + 15)),
        createdBy: "staff@ufps.edu.co",
      },
    ];

    logger.info(`Insertando ${userFeedback.length} registros de feedback...`);
    await userFeedbackModel.insertMany(userFeedback);

    // Evaluaciones administrativas (RF-35)
    const userEvaluations = [
      {
        evaluatedUserId: "docente@ufps.edu.co",
        evaluatedUserName: "Juan Docente",
        evaluatorId: "admin@ufps.edu.co",
        evaluatorName: "Admin Principal",
        period: "Q1-2024",
        totalReservations: 12,
        completedReservations: 11,
        cancelledReservations: 1,
        noShowCount: 0,
        averageCheckInDelay: 5, // minutos
        complianceScore: 95,
        rating: 5,
        comments:
          "Usuario ejemplar. Siempre llega a tiempo y cuida los recursos.",
        strengths: [
          "Puntualidad excelente",
          "Uso responsable de recursos",
          "Comunicaci√≥n proactiva",
        ],
        areasForImprovement: ["Podr√≠a cancelar con m√°s anticipaci√≥n"],
        recommendForPriorityAccess: true,
        evaluatedAt: new Date(lastMonth),
        createdBy: "admin@ufps.edu.co",
      },
      {
        evaluatedUserId: "estudiante@ufps.edu.co",
        evaluatedUserName: "Mar√≠a Estudiante",
        evaluatorId: "admin.sistemas@ufps.edu.co",
        evaluatorName: "Admin Sistemas",
        period: "Q1-2024",
        totalReservations: 8,
        completedReservations: 6,
        cancelledReservations: 2,
        noShowCount: 0,
        averageCheckInDelay: 10,
        complianceScore: 75,
        rating: 3,
        comments: "Usuario que requiere mayor compromiso con las reservas.",
        strengths: [
          "Reporta incidentes oportunamente",
          "Uso adecuado de recursos",
        ],
        areasForImprovement: [
          "Reducir cancelaciones de √∫ltimo momento",
          "Mejorar puntualidad en check-in",
        ],
        recommendForPriorityAccess: false,
        evaluatedAt: new Date(lastMonth),
        createdBy: "admin.sistemas@ufps.edu.co",
      },
      {
        evaluatedUserId: "staff@ufps.edu.co",
        evaluatedUserName: "Ana Staff",
        evaluatorId: "admin@ufps.edu.co",
        evaluatorName: "Admin Principal",
        period: "Q1-2024",
        totalReservations: 15,
        completedReservations: 15,
        cancelledReservations: 0,
        noShowCount: 0,
        averageCheckInDelay: 2,
        complianceScore: 100,
        rating: 5,
        comments:
          "Usuario perfecto. Siempre cumple con las reservas y es muy puntual.",
        strengths: [
          "Cumplimiento perfecto",
          "Puntualidad excepcional",
          "Uso eficiente de recursos",
        ],
        areasForImprovement: [],
        recommendForPriorityAccess: true,
        evaluatedAt: new Date(lastMonth),
        createdBy: "admin@ufps.edu.co",
      },
    ];

    logger.info(
      `Insertando ${userEvaluations.length} evaluaciones de usuarios...`
    );
    await userEvaluationModel.insertMany(userEvaluations);

    // Estad√≠sticas de uso (RF-31, RF-32)
    const usageStatistics = [
      // Por recurso
      {
        type: "resource",
        resourceId: "auditorio-principal",
        resourceName: "Auditorio Principal",
        period: "monthly",
        year: 2024,
        month: 1,
        totalReservations: 45,
        confirmedReservations: 40,
        cancelledReservations: 5,
        totalHours: 120,
        occupancyRate: 75,
        averageAttendees: 180,
        peakUsageHours: ["16:00-18:00", "10:00-12:00"],
        createdBy: "system",
      },
      {
        type: "resource",
        resourceId: "laboratorio-sistemas-1",
        resourceName: "Laboratorio de Sistemas 1",
        period: "monthly",
        year: 2024,
        month: 1,
        totalReservations: 60,
        confirmedReservations: 58,
        cancelledReservations: 2,
        totalHours: 180,
        occupancyRate: 90,
        averageAttendees: 28,
        peakUsageHours: ["14:00-16:00", "08:00-10:00"],
        createdBy: "system",
      },
      // Por programa
      {
        type: "program",
        program: "Ingenier√≠a de Sistemas",
        period: "monthly",
        year: 2024,
        month: 1,
        totalReservations: 85,
        confirmedReservations: 80,
        cancelledReservations: 5,
        totalHours: 240,
        mostUsedResources: [
          "laboratorio-sistemas-1",
          "sala-conferencias-a",
          "auditorio-principal",
        ],
        createdBy: "system",
      },
      // Por usuario
      {
        type: "user",
        userId: "docente@ufps.edu.co",
        userName: "Juan Docente",
        period: "monthly",
        year: 2024,
        month: 1,
        totalReservations: 12,
        confirmedReservations: 11,
        cancelledReservations: 1,
        totalHours: 30,
        favoriteResources: ["laboratorio-sistemas-1", "auditorio-principal"],
        createdBy: "system",
      },
    ];

    logger.info(`Insertando ${usageStatistics.length} estad√≠sticas de uso...`);
    await usageStatisticModel.insertMany(usageStatistics);

    // Demanda insatisfecha (RF-37)
    const unsatisfiedDemand = [
      {
        resourceId: "auditorio-principal",
        resourceName: "Auditorio Principal",
        resourceType: "auditorio",
        requestedDate: new Date(today.setDate(today.getDate() + 3)),
        requestedStartTime: "16:00",
        requestedEndTime: "18:00",
        requesterId: "estudiante@ufps.edu.co",
        requesterName: "Mar√≠a Estudiante",
        reason: "resource_occupied",
        alternativeSuggested: "sala-conferencias-a",
        alternativeAccepted: false,
        addedToWaitList: true,
        priority: "medium",
        createdAt: new Date(),
        createdBy: "system",
      },
      {
        resourceId: "proyector-portatil-1",
        resourceName: "Proyector Port√°til 1",
        resourceType: "equipo",
        requestedDate: new Date(lastWeek),
        requestedStartTime: "14:00",
        requestedEndTime: "18:00",
        requesterId: "estudiante@ufps.edu.co",
        requesterName: "Mar√≠a Estudiante",
        reason: "approval_rejected",
        alternativeSuggested: null,
        alternativeAccepted: false,
        addedToWaitList: false,
        priority: "low",
        createdAt: new Date(lastWeek),
        createdBy: "system",
      },
      {
        resourceId: "laboratorio-sistemas-1",
        resourceName: "Laboratorio de Sistemas 1",
        resourceType: "laboratorio",
        requestedDate: new Date(lastMonth.setDate(lastMonth.getDate() + 20)),
        requestedStartTime: "10:00",
        requestedEndTime: "12:00",
        requesterId: "docente@ufps.edu.co",
        requesterName: "Juan Docente",
        reason: "resource_occupied",
        alternativeSuggested: "laboratorio-sistemas-2",
        alternativeAccepted: true,
        addedToWaitList: false,
        priority: "high",
        createdAt: new Date(lastMonth.setDate(lastMonth.getDate() + 20)),
        createdBy: "system",
      },
    ];

    logger.info(
      `Insertando ${unsatisfiedDemand.length} registros de demanda insatisfecha...`
    );
    await unsatisfiedDemandModel.insertMany(unsatisfiedDemand);

    logger.info("‚úÖ Seed de Reports Service completado exitosamente");
    logger.info("Estad√≠sticas:");
    logger.info(`  - ${userFeedback.length} registros de feedback creados`);
    logger.info(
      `  - ${userEvaluations.length} evaluaciones de usuarios creadas`
    );
    logger.info(`  - ${usageStatistics.length} estad√≠sticas de uso creadas`);
    logger.info(
      `  - ${unsatisfiedDemand.length} registros de demanda insatisfecha creados`
    );
    logger.info("Ratings de feedback:");
    const avgRating =
      userFeedback.reduce((sum, f) => sum + f.rating, 0) / userFeedback.length;
    logger.info(`  - Promedio: ${avgRating.toFixed(1)}/5`);
    logger.info("Evaluaciones de usuarios:");
    logger.info(
      `  - Usuarios con acceso prioritario recomendado: ${userEvaluations.filter((e) => e.recommendForPriorityAccess).length}`
    );
    logger.info("Ocupaci√≥n de recursos:");
    logger.info(
      `  - Tasa promedio de ocupaci√≥n: ${usageStatistics.filter((s) => s.type === "resource").reduce((sum, s) => sum + (s.occupancyRate || 0), 0) / usageStatistics.filter((s) => s.type === "resource").length}%`
    );

    await app.close();
    process.exit(0);
  } catch (error) {
    logger.error("‚ùå Error en seed de Reports Service:", error);
    process.exit(1);
  }
}

// Ejecutar seed
seed();
