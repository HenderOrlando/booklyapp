# MD-006 — Importación Masiva de Recursos (RF-04)

## Resumen
Implementar sistema de importación masiva de recursos mediante CSV con validación previa, progreso asíncrono visible, reanudación de errores y sincronización con sistemas externos.

## Skills a invocar
- `web-app`: Modal complejo con drag & drop y progreso
- `backend`: Mock endpoints asíncronos con polling
- `arquitectura-escalabilidad-resiliencia`: Manejo de archivos grandes y reanudación
- `qa-calidad`: Tests de validación y flujo completo
- `operacion-interna-equipo`: Configuración de sincronización externa

## Qué construir

### 1. Botón "Importación Masiva"
- **Ubicación**: Lista de recursos (`/recursos`)
- **Componente**: Integrado en `ResourcesTable.tsx` o como botón flotante
- **Contenido**:
  - Icono de upload + texto "Importación Masiva"
  - Solo visible para admin
  - `data-testid="import-resources-button"`

### 2. Modal de Importación Completo
- **Componente**: `ImportResourcesModal.tsx`
- **Contenido**:
  - Paso 1: Descargar formato CSV de ejemplo
  - Paso 2: Subir archivo CSV (drag & drop o file input)
  - Paso 3: Validación completa ANTES de iniciar carga
  - Paso 4: Progreso asíncrono con barra y estado por fila
  - Paso 5: Resumen con éxitos/errores
  - `data-testid="import-resources-modal"`

### 3. Sistema de Progreso Persistente
- **Componente**: `ImportProgressIndicator.tsx`
- **Contenido**:
  - Barra de progreso global (% y filas procesadas)
  - Badge en header/sidebar si hay importación activa
  - Estado persistente si usuario cierra modal
  - `data-testid="import-progress-indicator"`

### 4. Reporte de Errores por Fila
- **Componente**: `ImportErrorReport.tsx`
- **Contenido**:
  - Tabla con filas con error
  - Columna: número fila, error, valor original
  - Opción "Corregir y reintentar"
  - "Continuar donde se quedó" (resume)
  - `data-testid="import-error-report"`

### 5. Configuración de Sincronización Externa
- **Componente**: `UniversitySyncConfig.tsx`
- **Ubicación**: Settings admin
- **Contenido**:
  - Endpoint externo (URL)
  - Mapeo de campos (dropdown de mapeo)
  - Frecuencia de sincronización
  - Autenticación (API key)
  - `data-testid="university-sync-config"`

## Rutas nuevas
Ninguna ruta nueva. Todo en modales y secciones existentes.

## Archivos a crear/modificar

### Frontend Components
- `src/components/organisms/ImportResourcesModal.tsx` - Nuevo
- `src/components/molecules/ImportProgress.tsx` - Nuevo
- `src/components/molecules/ImportErrorReport.tsx` - Nuevo
- `src/components/organisms/UniversitySyncConfig.tsx` - Nuevo
- `src/app/[locale]/recursos/page.tsx` - Modificar (agregar botón)

### Data y Mock
- `src/infrastructure/mock/data/import.mock.ts` - Nuevo
- `src/infrastructure/mock/mockService.ts` - Modificar (agregar endpoints)

### Tipos y Hooks
- `src/types/entities/import.ts` - Nuevo
- `src/hooks/useResourceImport.ts` - Nuevo
- `src/store/importSlice.ts` - Nuevo (estado global persistente)

### Internacionalización
- `src/i18n/translations/es/import.json` - Nuevo
- `src/i18n/translations/en/import.json` - Nuevo
- `src/i18n/request.ts` - Modificar (agregar namespace)

## Mock Data Structure
```typescript
interface ImportJob {
  id: string;
  status: 'pending' | 'processing' | 'completed' | 'failed' | 'partial';
  totalRows: number;
  processedRows: number;
  successfulRows: number;
  failedRows: number;
  startedAt?: Date;
  completedAt?: Date;
  errors: ImportError[];
  resumeAvailable: boolean;
}

interface ImportError {
  row: number;
  field: string;
  value: string;
  message: string;
  severity: 'error' | 'warning';
}

interface ImportRow {
  row: number;
  name: string;
  code: string;
  type: string;
  capacity: number;
  location: string;
  categoryCode: string;
  status: 'pending' | 'processing' | 'success' | 'error';
  error?: string;
}

interface UniversitySync {
  id: string;
  endpoint: string;
  fieldMapping: Record<string, string>;
  frequency: number; // minutos
  lastSync?: Date;
  isActive: boolean;
  apiKey?: string;
}
```

## Formato CSV (Backend)
```csv
name,code,type,capacity,location,categoryCode
"Laboratorio de Física","LAB-FIS-101","laboratory",30,"Edificio A Piso 2","LAB"
"Aula Magna","AUL-MAG-001","classroom",200,"Edificio Central Piso 1","AULA"
```

## Mock Endpoints
```typescript
// POST /api/resources/import (iniciar importación)
// GET /api/resources/import/:id/status (consultar progreso)
// POST /api/resources/import/:id/resume (reanudar desde error)
// GET /api/resources/import/:id/errors (detalle de errores)
// POST /api/university/sync/config (configurar sincronización)
// GET /api/university/sync/status
```

## Flujo de Validación
```typescript
// 1. Validar estructura CSV (columnas requeridas)
// 2. Validar tipos de datos por columna
// 3. Validar códigos duplicados
// 4. Validar códigos de categoría existentes
// 5. Retornar resumen: X válidos, Y errores
// 6. Solo si usuario confirma, iniciar procesamiento
```

## Tests

### Unit Tests
- `ImportResourcesModal` component test
- `ImportProgress` component test
- `ImportErrorReport` component test
- Validación de formato CSV

### E2E Tests
- **E2E-RES-017**: Admin abre modal, sube CSV, ve progreso, confirma recursos creados
  - `data-testid="import-resources-modal"`
  - `data-testid="import-progress-indicator"`
- **Regression**: Validación de formato incorrecto antes de carga
- **Regression**: Cerrar modal y verificar progreso sigue visible
- **Regression**: Error parcial y resume desde donde se quedó

## Criterios de Aceptancia
- [ ] Admin puede descargar plantilla CSV
- [ ] Sistema valida archivo completo antes de procesar
- [ ] Progreso es visible y persistente entre vistas
- [ ] Errores se muestran por fila con opción de corregir
- [ ] Reanudación funciona desde errores parciales
- [ ] Sincronización externa es configurable
- [ ] UI es responsive y accesible
- [ ] Todos los tests pasan

## Dependencias
- `react-dropzone` para drag & drop
- `react-query` para polling de estado
- `zustand` o Redux para estado persistente
- `papaparse` para parsing CSV
- `date-fns` para timestamps

## Riesgos y Consideraciones
- Límite de tamaño de archivo (ej: 5MB max)
- Timeout para importaciones grandes
- Concurrencia: solo una importación activa por usuario
- Rollback automático si hay errores críticos
- Memory usage con archivos grandes

## Estados del Proceso
```typescript
const IMPORT_STATES = {
  UPLOADING: 'Subiendo archivo...',
  VALIDATING: 'Validando estructura...',
  CONFIRMING: 'Esperando confirmación...',
  PROCESSING: 'Procesando filas...',
  COMPLETED: 'Importación completada',
  FAILED: 'Error en importación',
  PARTIAL: 'Completado con errores'
};
```
