# MD-011 — Baselines Visuales Light/Dark Mode

## Resumen
Implementar suite completa de pruebas visuales con baselines para light y dark mode, asegurando consistencia visual en toda la aplicación.

## Skills a invocar
- `web-app`: Asegurar compatibilidad completa de themes
- `qa-calidad`: Configuración de suite visual y baselines
- `plataforma-build-deploy-operate-observe`: Integración en CI/CD
- `ux-ui`: Validación de consistencia visual

## Qué construir

### 1. Verificación de Soporte Complete de Themes
- **Componente**: Revisar toda la app con `next-themes`
- **Contenido**:
  - Asegurar que todos los componentes respeten dark mode
  - Corregir colores hardcodeados
  - Verificar transiciones suaves entre themes
  - `data-testid="theme-toggle"` para botón de cambio

### 2. Suite Visual de Playwright
- **Archivo**: `e2e/visual/visual.spec.ts`
- **Contenido**:
  - Tests para 7 páginas × 2 themes = 14 screenshots
  - Configuración de theme antes de cada screenshot
  - Comparación contra baselines
  - `data-testid="visual-screenshot-{page}-{theme}"`

### 3. Helper para Theme Toggle
- **Archivo**: `e2e/helpers/theme.helper.ts`
- **Contenido**:
  - Función `setTheme(page, theme)`
  - Esperar a que se aplique el theme
  - Validar que el theme esté activo

### 4. Configuración de Playwright
- **Archivo**: `playwright.config.ts`
- **Contenido**:
  - Proyectos `visual-light` y `visual-dark`
  - Configuración de snapshots directory
  - Timeout extendido para screenshots

## Páginas para Baseline (7 páginas × 2 themes)

### 1. Login (`/es/login`)
- Elements: formulario, campos, botón, links
- Theme check: fondo, inputs, botones

### 2. Dashboard (`/es/dashboard`)
- Elements: cards, métricas, gráficos
- Theme check: colores de datos, fondos

### 3. Recursos (`/es/recursos`)
- Elements: tabla, filtros, botones
- Theme check: tabla, paginación, modales

### 4. Reservas (`/es/reservas`)
- Elements: cards de reserva, calendario
- Theme check: estados de reserva, colores

### 5. Calendario (`/es/calendario`)
- Elements: vista mensual, eventos
- Theme check: colores de eventos, fondo

### 6. Aprobaciones (`/es/aprobaciones`)
- Elements: lista de aprobaciones, acciones
- Theme check: badges, botones de acción

### 7. Reportes (`/es/reportes`)
- Elements: dashboard de reportes, gráficos
- Theme check: colores de gráficos, fondos

## Archivos a crear/modificar

### E2E Tests
- `e2e/visual/visual.spec.ts` - Nuevo
- `e2e/helpers/theme.helper.ts` - Nuevo
- `e2e/visual/.gitkeep` - Nuevo (directorio)

### Configuración
- `playwright.config.ts` - Modificar (agregar proyectos visuales)
- `package.json` - Modificar (scripts para tests visuales)

### Componentes (si necesitan corrección)
- Revisar y corregir componentes que no respeten dark mode
- `src/components/**/*.tsx` - Potencialmente modificar

## Mock Data Structure
```typescript
// No aplica para tests visuales
// Se usan datos existentes del modo mock
```

## Mock Endpoints
```typescript
// No aplica para tests visuales
// Se usan endpoints existentes del modo mock
```

## Helper Functions
```typescript
// e2e/helpers/theme.helper.ts
export async function setTheme(page: Page, theme: 'light' | 'dark') {
  // Encontrar y hacer clic en toggle de theme
  const themeToggle = page.locator('[data-testid="theme-toggle"]');
  await themeToggle.click();
  
  // Esperar a que se aplique el theme
  await page.waitForTimeout(500);
  
  // Verificar theme activo
  const html = page.locator('html');
  const currentTheme = await html.getAttribute('class');
  
  if (theme === 'dark' && !currentTheme?.includes('dark')) {
    await themeToggle.click(); // Toggle again if needed
    await page.waitForTimeout(500);
  }
}

export async function takeScreenshot(page: Page, name: string) {
  await page.waitForLoadState('networkidle');
  await page.screenshot({
    path: `e2e/visual/${name}.png`,
    fullPage: true
  });
}
```

## Configuración Playwright
```typescript
// playwright.config.ts (adición)
projects: [
  // ... proyectos existentes
  
  {
    name: 'visual-light',
    testMatch: '**/visual/**/*.spec.ts',
    use: {
      ...baseUse,
      viewport: { width: 1280, height: 720 },
      ignoreHTTPSErrors: true,
    },
  },
  
  {
    name: 'visual-dark',
    testMatch: '**/visual/**/*.spec.ts',
    use: {
      ...baseUse,
      viewport: { width: 1280, height: 720 },
      ignoreHTTPSErrors: true,
    },
  }
]
```

## Tests

### Visual Regression Tests
```typescript
// e2e/visual/visual.spec.ts
import { test, expect } from '@playwright/test';
import { setTheme, takeScreenshot } from '../helpers/theme.helper';

const pages = [
  '/es/login',
  '/es/dashboard',
  '/es/recursos',
  '/es/reservas',
  '/es/calendario',
  '/es/aprobaciones',
  '/es/reportes'
];

test.describe('Visual Baselines', () => {
  pages.forEach(page => {
    test(`light mode - ${page}`, async ({ page: browserPage }) => {
      await browserPage.goto(page);
      await setTheme(browserPage, 'light');
      await takeScreenshot(browserPage, `light-${page.replace('/es/', '').replace('/', '-')}`);
    });
    
    test(`dark mode - ${page}`, async ({ page: browserPage }) => {
      await browserPage.goto(page);
      await setTheme(browserPage, 'dark');
      await takeScreenshot(browserPage, `dark-${page.replace('/es/', '').replace('/', '-')}`);
    });
  });
});
```

## Scripts en package.json
```json
{
  "scripts": {
    "test:visual:update": "playwright test --config playwright.config.ts --update-snapshots",
    "test:visual": "playwright test --config playwright.config.ts --project=visual-light --project=visual-dark",
    "test:visual:light": "playwright test --config playwright.config.ts --project=visual-light",
    "test:visual:dark": "playwright test --config playwright.config.ts --project=visual-dark"
  }
}
```

## Criterios de Aceptancia
- [ ] Todos los componentes funcionan correctamente en light y dark mode
- [ ] 14 screenshots baselines generados (7 páginas × 2 themes)
- [ ] Suite visual se ejecuta sin errores
- [ ] Los baselines se actualizan correctamente con `--update-snapshots`
- [ ] Las diferencias visuales se detectan apropiadamente
- [ ] Transiciones entre themes son suaves
- [ ] No hay colores hardcodeados que rompan el theme
- [ ] Todos los tests visuales pasan

## Dependencias
- `next-themes` (ya existente)
- `@playwright/test` (ya existente)
- Playwright visual comparison (built-in)

## Riesgos y Consideraciones
- Tiempo de ejecución: 14 screenshots pueden tardar
- Espacio en disco: Los baselines ocupan espacio
- Falsos positivos: Pequeñas variaciones pueden generar diffs
- Actualización de baselines: Proceso manual requerido

## Directorio de Snapshots
```
e2e/visual/
├── light-login.png
├── dark-login.png
├── light-dashboard.png
├── dark-dashboard.png
├── light-recursos.png
├── dark-recursos.png
├── light-reservas.png
├── dark-reservas.png
├── light-calendario.png
├── dark-calendario.png
├── light-aprobaciones.png
├── dark-aprobaciones.png
├── light-reportes.png
└── dark-reportes.png
```

## Integración CI/CD
```yaml
# .github/workflows/e2e-frontend.yml (adición)
- name: Run Visual Tests
  run: npm run test:visual
  
- name: Upload Visual Snapshots
  if: failure()
  uses: actions/upload-artifact@v3
  with:
    name: visual-diffs
    path: e2e/visual/
```
