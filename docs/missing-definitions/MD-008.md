# MD-008 — Reservas Múltiples en una Solicitud (RF-19)

## Resumen
Implementar capacidad de crear múltiples reservas en una sola solicitud, con validación de conflictos, calendario multi-selección y confirmación por lotes.

## Skills a invocar
- `web-app`: Calendario multi-selección, wizard de reservas, confirmación por lotes
- `backend`: Mock endpoints para reservas múltiples, validación de conflictos
- `seguridad-privacidad-compliance`: Validación de permisos y límites por usuario
- `qa-calidad`: Tests E2E de flujo de reservas múltiples
- `arquitectura-escalabilidad-resiliencia`: Manejo de reservas concurrentes y conflictos

## Qué construir

### 1. Modo Multi-Reserva en Calendario
- **Ubicación**: `/reservas/nueva` (extender formulario existente)
- **Componente**: `MultiReservationCalendar.tsx`
- **Contenido**:
  - Toggle "Modo Multi-Reserva" en formulario
  - Calendario con selección múltiple de slots
  - Visualización de slots seleccionados
  - Validación en tiempo real de conflictos
  - `data-testid="multi-reservation-toggle"`
  - `data-testid="multi-reservation-calendar"`

### 2. Wizard de Confirmación
- **Ubicación**: Modal o página intermedia
- **Componente**: `MultiReservationWizard.tsx`
- **Contenido**:
  - Paso 1: Revisión de slots seleccionados
  - Paso 2: Detalles comunes (asistentes, notas)
  - Paso 3: Confirmación y creación
  - Indicador de progreso
  - `data-testid="multi-reservation-wizard"`

### 3. Validación de Conflictos
- **Ubicación**: Servicio y UI
- **Componente**: `ConflictValidator.tsx`
- **Contenido**:
  - Verificación de disponibilidad para cada slot
  - Resaltado visual de conflictos
  - Sugerencias de slots alternativos
  - Mensajes claros de conflicto
  - `data-testid="conflict-validator"`

### 4. Creación por Lotes
- **Ubicación**: Backend mock
- **Endpoint**: `POST /api/reservations/batch`
- **Contenido**:
  - Array de reservas en una sola petición
  - Validación atómica (todo o nada)
  - Respuesta con IDs de reservas creadas
  - Manejo de errores parciales

### 5. Vista de Reservas Múltiples
- **Ubicación**: `/reservas` (extender lista existente)
- **Contenido**:
  - Agrupación por solicitud de lote
  - Indicador visual de "reserva múltiple"
  - Acciones por lote (cancelar todo)
  - `data-testid="batch-reservation-group"`

## Rutas nuevas
Ninguna ruta nueva. Se integra en páginas existentes con modos adicionales.

## Archivos a crear/modificar

### Frontend Components
- `src/components/molecules/MultiReservationCalendar.tsx` - Nuevo
- `src/components/organisms/MultiReservationWizard.tsx` - Nuevo
- `src/components/organisms/ConflictValidator.tsx` - Nuevo
- `src/components/molecules/BatchReservationCard.tsx` - Nuevo
- `src/app/[locale]/reservas/nueva/page.tsx` - Modificar (agregar modo multi)
- `src/app/[locale]/reservas/page.tsx` - Modificar (agregar vista por lote)

### Data y Mock
- `src/infrastructure/mock/data/reservations-batch.mock.ts` - Nuevo
- `src/infrastructure/mock/mockService.ts` - Modificar (agregar endpoint batch)

### Tipos y Hooks
- `src/types/entities/reservation.ts` - Modificar (extender con batch)
- `src/types/entities/batch-reservation.ts` - Nuevo
- `src/hooks/useMultiReservation.ts` - Nuevo
- `src/hooks/useConflictValidation.ts` - Nuevo

### Internacionalización
- `src/i18n/translations/es/reservations.json` - Modificar (agregar claves multi)
- `src/i18n/translations/en/reservations.json` - Modificar (agregar claves multi)

## Mock Data Structure
```typescript
interface BatchReservationRequest {
  reservations: Omit<CreateReservationDto, 'userId'>[];
  commonData?: {
    attendees?: number;
    notes?: string;
    purpose?: string;
  };
  validateConflicts?: boolean;
  atomicMode?: boolean; // todo o nada
}

interface BatchReservationResponse {
  batchId: string;
  reservations: Reservation[];
  conflicts?: ConflictInfo[];
  failed?: FailedReservation[];
  success: boolean;
}

interface ConflictInfo {
  slotIndex: number;
  resourceId: string;
  conflictType: 'overlap' | 'unavailable' | 'limit_exceeded';
  suggestedAlternatives?: TimeSlot[];
}

interface FailedReservation {
  slotIndex: number;
  error: string;
  code: string;
}
```

## Mock Endpoints
```typescript
// POST /api/reservations/batch
// GET /api/reservations/validate-slots (pre-validación)
// GET /api/reservations/batch/:batchId (consulta estado)
// DELETE /api/reservations/batch/:batchId (cancelar todo)
```

## Flujo Completo
```typescript
// 1. Usuario activa "Modo Multi-Reserva"
// 2. Selecciona múltiples slots en calendario
// 3. Sistema valida conflictos en tiempo real
// 4. Usuario abre wizard de confirmación
// 5. Ingresa datos comunes (asistentes, notas)
// 6. Sistema pre-valida todos los slots
// 7. Usuario confirma creación
// 8. Backend crea reservas en batch
// 9. Usuario ve confirmación con IDs
// 10. Vista de reservas muestra agrupación por lote
```

## Tests

### Unit Tests
- `MultiReservationCalendar` component test
- `ConflictValidator` logic test
- Batch creation service test

### E2E Tests
- **E2E-AVL-022**: Crear reserva múltiple con slots válidos
  - `data-testid="multi-reservation-toggle"`
  - `data-testid="multi-reservation-calendar"`
- **Regression**: Validar detección de conflictos
  - `data-testid="conflict-validator"`
- **Regression**: Cancelar lote completo de reservas
  - `data-testid="batch-reservation-group"`
- **Regression**: Límite máximo de reservas por lote

## Criterios de Aceptancia
- [ ] Usuario puede activar modo multi-reserva
- [ ] Calendario permite selección múltiple de slots
- [ ] Sistema valida conflictos en tiempo real
- [ ] Wizard guía por pasos de confirmación
- [ ] Creación por lote es atómica (todo o nada)
- [ ] Vista de reservas muestra agrupación por lote
- [ ] Se pueden cancelar todas las reservas de un lote
- [ ] Todos los tests pasan

## Dependencias
- `date-fns` para manejo de fechas y rangos
- `react-query` para manejo de estado asíncrono
- Componente de calendario existente (extender)

## Riesgos y Consideraciones
- Performance: Validar muchos slots puede ser costoso
- Concurrencia: Múltiples usuarios creando reservas simultáneas
- Límites: Definir máximo de reservas por lote (ej: 10)
- Conflicto: Qué hacer si algunos slots fallan (parcial vs total)
- UX: Complejidad del wizard vs simplicidad

## Estados Visual en UI
```typescript
const BATCH_STATES = {
  'selecting': {
    label: 'Seleccionando Horarios',
    color: 'blue',
    icon: 'calendar'
  },
  'validating': {
    label: 'Validando Disponibilidad',
    color: 'orange',
    icon: 'search'
  },
  'confirming': {
    label: 'Confirmando Reservas',
    color: 'purple',
    icon: 'check-circle'
  },
  'completed': {
    label: 'Reservas Creadas',
    color: 'green',
    icon: 'check'
  },
  'has_conflicts': {
    label: 'Hay Conflictos',
    color: 'red',
    icon: 'x-circle'
  }
};
```

## Límites y Validaciones
```typescript
const BATCH_LIMITS = {
  maxReservationsPerBatch: 10,
  maxDaysInAdvance: 90,
  minHoursBetweenSlots: 1,
  maxConcurrentReservations: 5,
  requireSameResource: false, // puede ser mixto
  allowOverlappingDays: true
};
```
