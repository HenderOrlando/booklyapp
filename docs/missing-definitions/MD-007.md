# MD-007 — VoBo Docente para Estudiantes (RF-13)

## Resumen
Implementar flujo de aprobación (VoBo) de docentes para reservas de estudiantes, con selección de profesores, tiempo de respuesta configurable y notificaciones automáticas.

## Skills a invocar
- `web-app`: Campos en formulario de reserva y vista de aprobaciones
- `backend`: Mock endpoints de VoBo y timeout
- `seguridad-privacidad-compliance`: Validación de roles y permisos
- `qa-calidad`: Tests E2E de flujo de aprobación
- `legal-product`: Manejo de rechazos con motivos auditables

## Qué construir

### 1. Campo "Profesores para VoBo" en Formulario de Reserva
- **Ubicación**: Formulario nueva reserva (`/reservas/nueva`)
- **Componente**: `ProfessorVoBoSelect.tsx`
- **Contenido**:
  - Multiselect de profesores habilitados (solo visible si rol=estudiante)
  - Al menos 1 profesor requerido para estudiantes
  - Search/filter de profesores
  - Mostrar info: nombre, departamento, foto
  - `data-testid="professor-vobo-select"`

### 2. Flujo de Estados de Reserva
- **Estados nuevos**:
  - `pending-vobo` - Pendiente de aprobación docente
  - `vobo-approved` - Aprobada por docente
  - `vobo-rejected` - Rechazada por docente
- **UI**: Estados visibles en tarjetas de reserva

### 3. Vista en Aprobaciones para Profesores
- **Ubicación**: `/aprobaciones` (extender existente)
- **Contenido**:
  - Las solicitudes de VoBo aparecen como tipo especial
  - Acciones: Aprobar/Rechazar con motivo obligatorio
  - Info: estudiante, recurso, fecha/hora
  - `data-testid="vobo-approval-item"`

### 4. Configuración de Tiempo de Respuesta
- **Ubicación**: Settings admin (`/admin/configuracion`)
- **Componente**: `VoBoTimeoutConfig.tsx`
- **Contenido**:
  - Timeout configurable (ej: 24h por defecto)
  - Acción automática: rechazar sin respuesta
  - Notificación automática al expirar

### 5. Notificaciones Automáticas
- **Al profesor**: Nueva solicitud de VoBo
- **Al estudiante**: Aprobación/rechazo de VoBo
- **Al estudiante**: Recordatorio antes de expirar timeout
- **Canal**: Email + toast en app

## Rutas nuevas
Ninguna ruta nueva. Se integra en páginas existentes.

## Archivos a crear/modificar

### Frontend Components
- `src/components/molecules/ProfessorVoBoSelect.tsx` - Nuevo
- `src/components/organisms/VoBoApprovalCard.tsx` - Nuevo
- `src/components/organisms/VoBoTimeoutConfig.tsx` - Nuevo
- `src/app/[locale]/reservas/nueva/page.tsx` - Modificar (agregar campo VoBo)
- `src/app/[locale]/aprobaciones/page.tsx` - Modificar (extender para VoBo)
- `src/app/[locale]/admin/configuracion/page.tsx` - Modificar (agregar timeout)

### Data y Mock
- `src/infrastructure/mock/data/vobo.mock.ts` - Nuevo
- `src/infrastructure/mock/mockService.ts` - Modificar (agregar endpoints)

### Tipos y Hooks
- `src/types/entities/reservation.ts` - Modificar (extender con VoBo)
- `src/types/entities/vobo.ts` - Nuevo
- `src/hooks/useVoBo.ts` - Nuevo
- `src/hooks/useProfessorSelect.ts` - Nuevo

### Internacionalización
- `src/i18n/translations/es/reservations.json` - Modificar (agregar claves VoBo)
- `src/i18n/translations/en/reservations.json` - Modificar (agregar claves VoBo)

## Mock Data Structure
```typescript
interface VoBoRequest {
  id: string;
  reservationId: string;
  studentId: string;
  studentName: string;
  professorId: string;
  professorName: string;
  resourceId: string;
  resourceName: string;
  requestedAt: Date;
  status: 'pending' | 'approved' | 'rejected' | 'expired';
  responseAt?: Date;
  responseReason?: string;
  timeoutHours: number;
  expiresAt: Date;
}

interface VoBoSettings {
  id: string;
  timeoutHours: number;
  autoRejectOnTimeout: boolean;
  reminderMinutes: number[];
  isActive: boolean;
}

interface Professor {
  id: string;
  name: string;
  email: string;
  department: string;
  photo?: string;
  isActive: boolean;
  canApprove: boolean;
}
```

## Mock Endpoints
```typescript
// GET /api/professors (lista de profesores habilitados)
// POST /api/reservations (con campo voboProfessors)
// GET /api/approvals/vobo/professor/:professorId
// POST /api/approvals/vobo/:requestId/approve
// POST /api/approvals/vobo/:requestId/reject
// GET /api/admin/vobo/settings
// PUT /api/admin/vobo/settings
```

## Flujo Completo
```typescript
// 1. Estudiante crea reserva con selección de profesores
// 2. Reserva queda en estado 'pending-vobo'
// 3. Notificación a profesores seleccionados
// 4. Profesor aprueba/rechaza con motivo
// 5. Si timeout sin respuesta → rechazo automático
// 6. Notificación a estudiante con resultado
// 7. Si aprobada → reserva confirmada
// 8. Si rechazada → estudiante puede crear nueva
```

## Tests

### Unit Tests
- `ProfessorVoBoSelect` component test
- `VoBoApprovalCard` component test
- Lógica de timeout y expiración

### E2E Tests
- **E2E-AVL-020**: Estudiante intenta reservar sin VoBo → error; con VoBo → queda pendiente
  - `data-testid="professor-vobo-select"`
- **Regression**: Profesor aprueba VoBo → reserva confirmada
  - `data-testid="vobo-approval-item"`
- **Regression**: Profesor rechaza VoBo → estudiante notificado
- **Regression**: Timeout sin respuesta → rechazo automático (mock timer)

## Criterios de Aceptancia
- [ ] Estudiante debe seleccionar al menos un profesor para VoBo
- [ ] Profesores reciben notificaciones de solicitudes
- [ ] Profesor puede aprobar/rechazar con motivo obligatorio
- [ ] Timeout configurable funciona correctamente
- [ ] Rechazo automático por timeout funciona
- [ ] Estudiante recibe notificación de resultado
- [ ] UI muestra estados correctamente
- [ ] Todos los tests pasan

## Dependencias
- `react-select` para multiselect con search
- `react-query` para manejo de estado
- `date-fns` para cálculo de timeout
- Sistema de notificaciones existente

## Riesgos y Consideraciones
- Múltiples profesores: ¿aprueba uno o todos? (definir: 1 basta)
- Profesor no disponible: sistema de reasignación
- Motivos de rechazo: catálogo predefinido vs libre
- Performance con muchos profesores activos

## Estados Visual en UI
```typescript
const RESERVATION_STATES = {
  'pending-vobo': {
    label: 'Pendiente de VoBo',
    color: 'orange',
    icon: 'clock'
  },
  'vobo-approved': {
    label: 'Aprobada por Docente',
    color: 'green',
    icon: 'check-circle'
  },
  'vobo-rejected': {
    label: 'Rechazada por Docente',
    color: 'red',
    icon: 'x-circle'
  }
};
```
