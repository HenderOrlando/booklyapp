# MD-003 — Espera Activa / Alertas en Tiempo Real (RF-30)

## Resumen
Implementar sistema de alertas en tiempo real cuando recursos quedan disponibles por cancelación, con suscripción activa y notificaciones instantáneas.

## Skills a invocar
- `web-app`: Extensión de UI en lista de espera y toasts globales
- `backend`: Mock endpoints de suscripción y notificaciones
- `arquitectura-escalabilidad-resiliencia`: Simulación de tiempo real con polling/WebSockets
- `qa-calidad`: Tests unitarios y E2E de flujo completo

## Qué construir

### 1. Botón "Activar Alerta de Disponibilidad"
- **Ubicación**: Flujo de reserva cuando recurso está ocupado
- **Componente**: `WaitlistSubscribeButton.tsx`
- **Contenido**:
  - Texto dinámico: "Notificarme cuando esté disponible"
  - Icono de campana
  - `data-testid="waitlist-subscribe-button"`
  - Estado: suscrito/no suscrito

### 2. Toast/Notificación en Tiempo Real
- **Componente**: `RealtimeAlertToast.tsx`
- **Contenido**:
  - "¡[Recurso] ahora está disponible!"
  - Botón "Reservar ahora" (navega a reserva)
  - Botón "Descartar"
  - `data-testid="realtime-alert-toast"`
  - Auto-dismiss después de 10 segundos

### 3. Vista de Suscripciones Activas
- **Ubicación**: Extender `/lista-espera`
- **Contenido**:
  - Tabla de recursos con alertas activas
  - Columnas: Recurso, Fecha suscripción, Acciones
  - Botón "Cancelar suscripción"
  - `data-testid="active-subscriptions-table"`

### 4. Cancelar Suscripción
- **Ubicación**: Perfil de usuario y lista de espera
- **Componente**: `CancelSubscriptionButton.tsx`
- **Contenido**: Confirmación antes de cancelar

### 5. Historial de Alertas (Admin)
- **Ubicación**: `/reportes/alertas` o sección en auditoría
- **Contenido**: Listado de alertas enviadas con métricas

## Rutas nuevas
Ninguna ruta nueva. Se extienden páginas existentes.

## Archivos a crear/modificar

### Frontend Components
- `src/components/molecules/WaitlistSubscribeButton.tsx` - Nuevo
- `src/components/atoms/RealtimeAlertToast.tsx` - Nuevo
- `src/components/molecules/CancelSubscriptionButton.tsx` - Nuevo
- `src/app/[locale]/lista-espera/page.tsx` - Modificar (extender)
- `src/components/organisms/GlobalToastContainer.tsx` - Modificar

### Data y Mock
- `src/infrastructure/mock/data/waitlist-alerts.mock.ts` - Nuevo
- `src/infrastructure/mock/mockService.ts` - Modificar (agregar endpoints)

### Tipos y Hooks
- `src/types/entities/waitlist.ts` - Modificar (extender)
- `src/hooks/useWaitlistAlerts.ts` - Nuevo
- `src/hooks/useRealtimeAlerts.ts` - Nuevo

### Internacionalización
- `src/i18n/translations/es/waitlist.json` - Modificar (agregar claves)
- `src/i18n/translations/en/waitlist.json` - Modificar (agregar claves)

## Mock Data Structure
```typescript
interface WaitlistSubscription {
  id: string;
  userId: string;
  resourceId: string;
  resourceCode: string;
  resourceName: string;
  subscribedAt: Date;
  isActive: boolean;
  notifiedCount: number;
}

interface RealtimeAlert {
  id: string;
  subscriptionId: string;
  userId: string;
  resourceId: string;
  message: string;
  actionUrl: string;
  createdAt: Date;
  isRead: boolean;
}
```

## Mock Endpoints
```typescript
// POST /api/waitlist/subscribe
// DELETE /api/waitlist/unsubscribe/:subscriptionId
// GET /api/waitlist/subscriptions?userId=
// POST /api/alerts/send (simulated)
// GET /api/admin/alerts/history
```

## Simulación de Tiempo Real
```typescript
// Mock con setTimeout para simular disponibilidad
const simulateResourceAvailable = (resourceId: string) => {
  setTimeout(() => {
    // Enviar alerta a suscriptores
    sendRealtimeAlert(resourceId);
  }, Math.random() * 30000); // 0-30 segundos
};
```

## Tests

### Unit Tests
- `WaitlistSubscribeButton` component test
- `RealtimeAlertToast` component test
- Lógica de suscripción/cancelación

### E2E Tests
- **Smoke**: Verificar botón de suscripción visible cuando recurso ocupado
  - `data-testid="waitlist-subscribe-button"`
- **Regression**: Suscribirse, verificar en lista, cancelar suscripción
  - `data-testid="active-subscriptions-table"`
- **Regression**: Simular alerta (mock) y verificar toast visible
  - `data-testid="realtime-alert-toast"`

## Criterios de Aceptancia
- [ ] Usuario puede suscribirse a alertas de recursos ocupados
- [ ] Las alertas llegan en tiempo real (simulado)
- [ ] El toast permite acción directa de reserva
- [ ] Usuario puede ver y cancelar suscripciones activas
- [ ] Admin puede ver historial de alertas enviadas
- [ ] Sistema maneja múltiples suscripciones por usuario
- [ ] UI es responsive y accesible
- [ ] Todos los tests pasan

## Dependencias
- Sistema de toast global existente
- Mock service con polling o WebSockets simulado
- `react-query` para manejo de estado

## Riesgos y Consideraciones
- Evitar spam de notificaciones (límite por usuario)
- Manejar desconexiones y reconexiones
- Prioridad de alertas (FIFO por tiempo de suscripción)
- Performance con muchas suscripciones activas
