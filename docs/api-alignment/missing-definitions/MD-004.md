# MD-004 — Cancelaciones y Ausencias (RF-40)

## Resumen
Implementar reportes de cancelaciones y ausencias con indicadores por usuario/recurso/tiempo, historial personal y alertas automáticas de umbrales críticos.

## Skills a invocar
- `web-app`: Nueva pantalla de reportes y sección en perfil
- `data-platform`: Mock data estructurado para reportes
- `backend`: Endpoints mock para reportes y filtros
- `qa-calidad`: Tests E2E de reportes y permisos
- `seguridad-privacidad-compliance`: Validación de acceso admin-only

## Qué construir

### 1. Sección "Historial" en Perfil de Usuario
- **Ubicación**: `/profile` (nueva tab o card)
- **Componente**: `CancellationHistoryCard.tsx`
- **Contenido**:
  - Historial propio de cancelaciones y ausencias
  - Porcentaje de cumplimiento (ej: "85% de asistencia")
  - Recomendaciones automáticas
  - Solo lectura, sin filtros avanzados
  - `data-testid="cancellation-history-card"`

### 2. Pantalla "Reporte de Cancelaciones"
- **Ruta**: `/reportes/cancelaciones` (nueva)
- **Permisos**: Solo admin (ProtectedRoute con `requiredRole: admin`)
- **Componentes**:
  - `CancellationReportFilters.tsx` - Filtros avanzados
  - `CancellationReportCharts.tsx` - Gráficos interactivos
  - `CancellationReportTable.tsx` - Tabla dinámica
- **Contenido**:
  - Filtros: rango de fechas, usuario, programa académico, tipo recurso
  - Gráficos (recharts): barras por tipo cancelación, línea temporal
  - Tabla con indicadores (% cancelaciones, % no-show por usuario)
  - Exportar CSV
  - Alertas de umbral crítico
  - `data-testid="cancellation-report-page"`

## Rutas nuevas
- `/reportes/cancelaciones` - Nueva ruta admin-only

## Archivos a crear/modificar

### Frontend Components
- `src/app/[locale]/reportes/cancelaciones/page.tsx` - Nuevo
- `src/components/molecules/CancellationHistoryCard.tsx` - Nuevo
- `src/components/organisms/CancellationReportFilters.tsx` - Nuevo
- `src/components/organisms/CancellationReportCharts.tsx` - Nuevo
- `src/components/organisms/CancellationReportTable.tsx` - Nuevo
- `src/app/[locale]/profile/page.tsx` - Modificar (agregar tab)

### Data y Mock
- `src/infrastructure/mock/data/cancellations.mock.ts` - Nuevo
- `src/infrastructure/mock/mockService.ts` - Modificar (agregar endpoints)

### Tipos y Hooks
- `src/types/entities/cancellation.ts` - Nuevo
- `src/hooks/useCancellationReport.ts` - Nuevo
- `src/hooks/useCancellationHistory.ts` - Nuevo

### Internacionalización
- `src/i18n/translations/es/cancellations.json` - Nuevo
- `src/i18n/translations/en/cancellations.json` - Nuevo
- `src/i18n/request.ts` - Modificar (agregar namespace)

### Navegación
- `src/components/organisms/AppSidebar.tsx` - Modificar (agregar link "Cancelaciones" bajo Reportes, solo admin)

## Mock Data Structure
```typescript
interface CancellationRecord {
  id: string;
  reservationId: string;
  userId: string;
  userName: string;
  resourceId: string;
  resourceName: string;
  programCode: string;
  cancellationType: 'early' | 'late' | 'no-show';
  cancelledAt: Date;
  reason?: string;
  scheduledStart: Date;
}

interface CancellationMetrics {
  userId: string;
  totalReservations: number;
  cancellations: number;
  noShows: number;
  cancellationRate: number;
  noShowRate: number;
  complianceRate: number;
}

interface CancellationReport {
  period: {
    from: Date;
    to: Date;
  };
  totalCancellations: number;
  earlyCancellations: number;
  lateCancellations: number;
  noShows: number;
  metricsByUser: CancellationMetrics[];
  metricsByResource: ResourceMetrics[];
  metricsByProgram: ProgramMetrics[];
}
```

## Mock Endpoints
```typescript
// GET /api/user/cancellations/history
// GET /api/admin/reports/cancellations?from=&to=&userId=&programCode=&resourceType=
// GET /api/admin/reports/cancellations/export/csv?params=
// GET /api/admin/reports/cancellations/metrics
```

## Gráficos y Visualizaciones
```typescript
// Barras: Cancelaciones por tipo (early/late/no-show)
// Línea: Tendencia de cancelaciones en el tiempo
// Tabla: Top usuarios con mayor índice de no-show
// KPIs: Tasas generales de cancelación y cumplimiento
```

## Tests

### Unit Tests
- `CancellationHistoryCard` component test
- `CancellationReportFilters` component test
- `CancellationReportCharts` component test
- Lógica de cálculo de métricas

### E2E Tests
- **E2E-RPT-018**: Admin navega a `/reportes/cancelaciones`, aplica filtros, verifica datos, exporta CSV
  - `data-testid="cancellation-report-page"`
- **Regression**: Usuario ve su historial en `/profile`
  - `data-testid="cancellation-history-card"`
- **Permission**: Estudiante no accede a `/reportes/cancelaciones` (redirect 403)

## Criterios de Aceptancia
- [ ] Usuario puede ver su historial de cancelaciones en perfil
- [ ] Admin puede acceder a reportes completos con filtros
- [ ] Los gráficos muestran datos correctos y son interactivos
- [ ] Exportación CSV funciona con todos los filtros aplicados
- [ ] Alertas automáticas se activan al superar umbrales críticos
- [ ] Métricas de cumplimiento se calculan correctamente
- [ ] UI es responsive y accesible
- [ ] Todos los tests pasan

## Dependencias
- `recharts` para gráficos interactivos
- `react-query` para manejo de datos
- `date-fns` para manejo de fechas
- Mock service existente

## Riesgos y Consideraciones
- Performance con grandes volúmenes de datos
- Privacidad: usuarios solo ven sus propios datos
- Consistencia de datos entre diferentes vistas
- Umbrales configurables para alertas

## Alertas Automáticas
```typescript
// Ejemplo de umbrales críticos
const CRITICAL_THRESHOLDS = {
  noShowRate: 0.15, // 15% no-show
  cancellationRate: 0.25, // 25% cancelación
  consecutiveNoShows: 3 // 3 no-show seguidos
};
```
