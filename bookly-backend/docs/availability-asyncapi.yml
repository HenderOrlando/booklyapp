asyncapi: 3.0.0
info:
  title: Bookly Availability Service Events
  version: 1.0.0
  description: |
    Event-driven architecture documentation for Bookly's availability and reservation management system.
    This service handles reservation scheduling, availability management, and calendar integration.
  contact:
    name: Bookly Development Team
    email: dev@booklyapp.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

defaultContentType: application/json

servers:
  development:
    host: localhost:5672
    protocol: amqp
    description: Local RabbitMQ development server
  production:
    host: rabbitmq.booklyapp.com:5672
    protocol: amqp
    description: Production RabbitMQ server

channels:
  reservation-management:
    description: Channel for reservation management events
    messages:
      reservationCreated:
        $ref: "#/components/messages/ReservationCreated"
      reservationUpdated:
        $ref: "#/components/messages/ReservationUpdated"
      reservationCancelled:
        $ref: "#/components/messages/ReservationCancelled"
      reservationConfirmed:
        $ref: "#/components/messages/ReservationConfirmed"
      reservationCheckIn:
        $ref: "#/components/messages/ReservationCheckIn"
      reservationCheckOut:
        $ref: "#/components/messages/ReservationCheckOut"

  availability-management:
    description: Channel for availability management events
    messages:
      availabilityUpdated:
        $ref: "#/components/messages/AvailabilityUpdated"
      availabilityBlocked:
        $ref: "#/components/messages/AvailabilityBlocked"
      availabilityUnblocked:
        $ref: "#/components/messages/AvailabilityUnblocked"
      recurringAvailabilityCreated:
        $ref: "#/components/messages/RecurringAvailabilityCreated"

  conflict-management:
    description: Channel for conflict and validation events
    messages:
      reservationConflictDetected:
        $ref: "#/components/messages/ReservationConflictDetected"
      reservationConflictResolved:
        $ref: "#/components/messages/ReservationConflictResolved"
      waitlistPositionChanged:
        $ref: "#/components/messages/WaitlistPositionChanged"

operations:
  publishReservationCreated:
    action: send
    channel:
      $ref: "#/channels/reservation-management"
    messages:
      - $ref: "#/channels/reservation-management/messages/reservationCreated"
    description: Published when a new reservation is created

  publishReservationUpdated:
    action: send
    channel:
      $ref: "#/channels/reservation-management"
    messages:
      - $ref: "#/channels/reservation-management/messages/reservationUpdated"
    description: Published when a reservation is updated

  publishReservationCancelled:
    action: send
    channel:
      $ref: "#/channels/reservation-management"
    messages:
      - $ref: "#/channels/reservation-management/messages/reservationCancelled"
    description: Published when a reservation is cancelled

  publishAvailabilityUpdated:
    action: send
    channel:
      $ref: "#/channels/availability-management"
    messages:
      - $ref: "#/channels/availability-management/messages/availabilityUpdated"
    description: Published when resource availability is updated

  publishReservationConflictDetected:
    action: send
    channel:
      $ref: "#/channels/conflict-management"
    messages:
      - $ref: "#/channels/conflict-management/messages/reservationConflictDetected"
    description: Published when a reservation conflict is detected

components:
  messages:
    ReservationCreated:
      name: ReservationCreated
      title: Reservation Created Event
      summary: Event published when a new reservation is created
      contentType: application/json
      payload:
        $ref: "#/components/schemas/ReservationCreatedPayload"

    ReservationUpdated:
      name: ReservationUpdated
      title: Reservation Updated Event
      summary: Event published when a reservation is updated
      contentType: application/json
      payload:
        $ref: "#/components/schemas/ReservationUpdatedPayload"

    ReservationCancelled:
      name: ReservationCancelled
      title: Reservation Cancelled Event
      summary: Event published when a reservation is cancelled
      contentType: application/json
      payload:
        $ref: "#/components/schemas/ReservationCancelledPayload"

    ReservationConfirmed:
      name: ReservationConfirmed
      title: Reservation Confirmed Event
      summary: Event published when a reservation is confirmed
      contentType: application/json
      payload:
        $ref: "#/components/schemas/ReservationConfirmedPayload"

    ReservationCheckIn:
      name: ReservationCheckIn
      title: Reservation Check-In Event
      summary: Event published when a user checks in to their reservation
      contentType: application/json
      payload:
        $ref: "#/components/schemas/ReservationCheckInPayload"

    ReservationCheckOut:
      name: ReservationCheckOut
      title: Reservation Check-Out Event
      summary: Event published when a user checks out from their reservation
      contentType: application/json
      payload:
        $ref: "#/components/schemas/ReservationCheckOutPayload"

    AvailabilityUpdated:
      name: AvailabilityUpdated
      title: Availability Updated Event
      summary: Event published when resource availability is updated
      contentType: application/json
      payload:
        $ref: "#/components/schemas/AvailabilityUpdatedPayload"

    AvailabilityBlocked:
      name: AvailabilityBlocked
      title: Availability Blocked Event
      summary: Event published when resource availability is blocked
      contentType: application/json
      payload:
        $ref: "#/components/schemas/AvailabilityBlockedPayload"

    AvailabilityUnblocked:
      name: AvailabilityUnblocked
      title: Availability Unblocked Event
      summary: Event published when resource availability is unblocked
      contentType: application/json
      payload:
        $ref: "#/components/schemas/AvailabilityUnblockedPayload"

    RecurringAvailabilityCreated:
      name: RecurringAvailabilityCreated
      title: Recurring Availability Created Event
      summary: Event published when recurring availability is created
      contentType: application/json
      payload:
        $ref: "#/components/schemas/RecurringAvailabilityCreatedPayload"

    ReservationConflictDetected:
      name: ReservationConflictDetected
      title: Reservation Conflict Detected Event
      summary: Event published when a reservation conflict is detected
      contentType: application/json
      payload:
        $ref: "#/components/schemas/ReservationConflictDetectedPayload"

    ReservationConflictResolved:
      name: ReservationConflictResolved
      title: Reservation Conflict Resolved Event
      summary: Event published when a reservation conflict is resolved
      contentType: application/json
      payload:
        $ref: "#/components/schemas/ReservationConflictResolvedPayload"

    WaitlistPositionChanged:
      name: WaitlistPositionChanged
      title: Waitlist Position Changed Event
      summary: Event published when a user's waitlist position changes
      contentType: application/json
      payload:
        $ref: "#/components/schemas/WaitlistPositionChangedPayload"

  schemas:
    DomainEvent:
      type: object
      required:
        - eventId
        - eventType
        - aggregateId
        - aggregateType
        - eventData
        - timestamp
        - version
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique identifier for the event
        eventType:
          type: string
          description: Type of the event
        aggregateId:
          type: string
          description: ID of the aggregate that generated the event
        aggregateType:
          type: string
          description: Type of the aggregate
        eventData:
          type: object
          description: Event-specific data payload
        timestamp:
          type: string
          format: date-time
          description: When the event occurred
        version:
          type: integer
          description: Version of the event schema

    ReservationCreatedPayload:
      allOf:
        - $ref: "#/components/schemas/DomainEvent"
        - type: object
          properties:
            eventData:
              type: object
              required:
                - reservationId
                - resourceId
                - userId
                - startTime
                - endTime
                - status
              properties:
                reservationId:
                  type: string
                  description: ID of the created reservation
                resourceId:
                  type: string
                  description: ID of the reserved resource
                userId:
                  type: string
                  description: ID of the user who made the reservation
                startTime:
                  type: string
                  format: date-time
                  description: Start time of the reservation
                endTime:
                  type: string
                  format: date-time
                  description: End time of the reservation
                status:
                  type: string
                  description: Status of the reservation
                purpose:
                  type: string
                  description: Purpose of the reservation
                attendees:
                  type: integer
                  description: Expected number of attendees

    ReservationUpdatedPayload:
      allOf:
        - $ref: "#/components/schemas/DomainEvent"
        - type: object
          properties:
            eventData:
              type: object
              required:
                - reservationId
                - updatedBy
                - changes
              properties:
                reservationId:
                  type: string
                  description: ID of the updated reservation
                updatedBy:
                  type: string
                  description: ID of the user who updated the reservation
                changes:
                  type: object
                  description: Fields that were changed
                previousValues:
                  type: object
                  description: Previous values of changed fields

    ReservationCancelledPayload:
      allOf:
        - $ref: "#/components/schemas/DomainEvent"
        - type: object
          properties:
            eventData:
              type: object
              required:
                - reservationId
                - cancelledBy
                - reason
                - cancelledAt
              properties:
                reservationId:
                  type: string
                  description: ID of the cancelled reservation
                cancelledBy:
                  type: string
                  description: ID of the user who cancelled the reservation
                reason:
                  type: string
                  description: Reason for cancellation
                cancelledAt:
                  type: string
                  format: date-time
                  description: When the reservation was cancelled
                refundAmount:
                  type: number
                  description: Amount refunded if applicable

    ReservationConfirmedPayload:
      allOf:
        - $ref: "#/components/schemas/DomainEvent"
        - type: object
          properties:
            eventData:
              type: object
              required:
                - reservationId
                - confirmedBy
                - confirmedAt
              properties:
                reservationId:
                  type: string
                  description: ID of the confirmed reservation
                confirmedBy:
                  type: string
                  description: ID of the user who confirmed the reservation
                confirmedAt:
                  type: string
                  format: date-time
                  description: When the reservation was confirmed

    ReservationCheckInPayload:
      allOf:
        - $ref: "#/components/schemas/DomainEvent"
        - type: object
          properties:
            eventData:
              type: object
              required:
                - reservationId
                - userId
                - checkInTime
              properties:
                reservationId:
                  type: string
                  description: ID of the reservation
                userId:
                  type: string
                  description: ID of the user checking in
                checkInTime:
                  type: string
                  format: date-time
                  description: When the check-in occurred
                location:
                  type: object
                  description: Location data if available

    ReservationCheckOutPayload:
      allOf:
        - $ref: "#/components/schemas/DomainEvent"
        - type: object
          properties:
            eventData:
              type: object
              required:
                - reservationId
                - userId
                - checkOutTime
              properties:
                reservationId:
                  type: string
                  description: ID of the reservation
                userId:
                  type: string
                  description: ID of the user checking out
                checkOutTime:
                  type: string
                  format: date-time
                  description: When the check-out occurred
                actualDuration:
                  type: integer
                  description: Actual duration in minutes

    AvailabilityUpdatedPayload:
      allOf:
        - $ref: "#/components/schemas/DomainEvent"
        - type: object
          properties:
            eventData:
              type: object
              required:
                - resourceId
                - updatedBy
                - availabilityRules
              properties:
                resourceId:
                  type: string
                  description: ID of the resource
                updatedBy:
                  type: string
                  description: ID of the user who updated availability
                availabilityRules:
                  type: object
                  description: New availability rules
                effectiveDate:
                  type: string
                  format: date-time
                  description: When the new availability takes effect

    AvailabilityBlockedPayload:
      allOf:
        - $ref: "#/components/schemas/DomainEvent"
        - type: object
          properties:
            eventData:
              type: object
              required:
                - resourceId
                - blockedBy
                - startTime
                - endTime
                - reason
              properties:
                resourceId:
                  type: string
                  description: ID of the blocked resource
                blockedBy:
                  type: string
                  description: ID of the user who blocked the resource
                startTime:
                  type: string
                  format: date-time
                  description: Start time of the block
                endTime:
                  type: string
                  format: date-time
                  description: End time of the block
                reason:
                  type: string
                  description: Reason for blocking
                isRecurring:
                  type: boolean
                  description: Whether this is a recurring block

    AvailabilityUnblockedPayload:
      allOf:
        - $ref: "#/components/schemas/DomainEvent"
        - type: object
          properties:
            eventData:
              type: object
              required:
                - resourceId
                - unblockedBy
                - blockId
              properties:
                resourceId:
                  type: string
                  description: ID of the unblocked resource
                unblockedBy:
                  type: string
                  description: ID of the user who unblocked the resource
                blockId:
                  type: string
                  description: ID of the block that was removed

    RecurringAvailabilityCreatedPayload:
      allOf:
        - $ref: "#/components/schemas/DomainEvent"
        - type: object
          properties:
            eventData:
              type: object
              required:
                - resourceId
                - createdBy
                - pattern
                - startDate
                - endDate
              properties:
                resourceId:
                  type: string
                  description: ID of the resource
                createdBy:
                  type: string
                  description: ID of the user who created the recurring availability
                pattern:
                  type: object
                  description: Recurrence pattern (daily, weekly, monthly, etc.)
                startDate:
                  type: string
                  format: date
                  description: Start date of the recurring pattern
                endDate:
                  type: string
                  format: date
                  description: End date of the recurring pattern

    ReservationConflictDetectedPayload:
      allOf:
        - $ref: "#/components/schemas/DomainEvent"
        - type: object
          properties:
            eventData:
              type: object
              required:
                - conflictId
                - reservationId
                - conflictingReservationId
                - resourceId
                - conflictType
              properties:
                conflictId:
                  type: string
                  description: ID of the conflict
                reservationId:
                  type: string
                  description: ID of the new reservation
                conflictingReservationId:
                  type: string
                  description: ID of the existing conflicting reservation
                resourceId:
                  type: string
                  description: ID of the resource in conflict
                conflictType:
                  type: string
                  description: Type of conflict (TIME_OVERLAP, RESOURCE_UNAVAILABLE, etc.)
                severity:
                  type: string
                  description: Severity of the conflict

    ReservationConflictResolvedPayload:
      allOf:
        - $ref: "#/components/schemas/DomainEvent"
        - type: object
          properties:
            eventData:
              type: object
              required:
                - conflictId
                - resolvedBy
                - resolution
              properties:
                conflictId:
                  type: string
                  description: ID of the resolved conflict
                resolvedBy:
                  type: string
                  description: ID of the user who resolved the conflict
                resolution:
                  type: string
                  description: How the conflict was resolved
                affectedReservations:
                  type: array
                  items:
                    type: string
                  description: IDs of reservations affected by the resolution

    WaitlistPositionChangedPayload:
      allOf:
        - $ref: "#/components/schemas/DomainEvent"
        - type: object
          properties:
            eventData:
              type: object
              required:
                - waitlistEntryId
                - userId
                - resourceId
                - previousPosition
                - newPosition
              properties:
                waitlistEntryId:
                  type: string
                  description: ID of the waitlist entry
                userId:
                  type: string
                  description: ID of the user on the waitlist
                resourceId:
                  type: string
                  description: ID of the resource
                previousPosition:
                  type: integer
                  description: Previous position in the waitlist
                newPosition:
                  type: integer
                  description: New position in the waitlist
                estimatedWaitTime:
                  type: integer
                  description: Estimated wait time in minutes
