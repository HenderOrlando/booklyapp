asyncapi: 3.0.0
info:
  title: Bookly Stockpile Service Events
  version: 1.0.0
  description: |
    Event-driven architecture documentation for Bookly's approval flow, document generation, and notification system.
    This service handles the complete workflow from reservation requests to final approval/rejection with automated document generation and notifications.
  contact:
    name: Bookly Development Team
    email: dev@booklyapp.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

defaultContentType: application/json

servers:
  development:
    host: localhost:5672
    protocol: amqp
    description: Local RabbitMQ development server
  production:
    host: rabbitmq.booklyapp.com:5672
    protocol: amqp
    description: Production RabbitMQ server

channels:
  approval-flow:
    description: Channel for approval flow events
    messages:
      reservationApproved:
        $ref: "#/components/messages/ReservationApproved"
      reservationRejected:
        $ref: "#/components/messages/ReservationRejected"
      approvalRequestCreated:
        $ref: "#/components/messages/ApprovalRequestCreated"
      approvalLevelCompleted:
        $ref: "#/components/messages/ApprovalLevelCompleted"
      approvalFlowCompleted:
        $ref: "#/components/messages/ApprovalFlowCompleted"

  document-generation:
    description: Channel for document generation events
    messages:
      documentGenerated:
        $ref: "#/components/messages/DocumentGenerated"
      documentTemplateCreated:
        $ref: "#/components/messages/DocumentTemplateCreated"
      documentTemplateUpdated:
        $ref: "#/components/messages/DocumentTemplateUpdated"

  notifications:
    description: Channel for notification events
    messages:
      notificationSent:
        $ref: "#/components/messages/NotificationSent"
      notificationTemplateCreated:
        $ref: "#/components/messages/NotificationTemplateCreated"
      notificationTemplateUpdated:
        $ref: "#/components/messages/NotificationTemplateUpdated"
      notificationConfigUpdated:
        $ref: "#/components/messages/NotificationConfigUpdated"

operations:
  publishReservationApproved:
    action: send
    channel:
      $ref: "#/channels/approval-flow"
    messages:
      - $ref: "#/channels/approval-flow/messages/reservationApproved"
    description: Published when a reservation is approved through the approval flow

  publishReservationRejected:
    action: send
    channel:
      $ref: "#/channels/approval-flow"
    messages:
      - $ref: "#/channels/approval-flow/messages/reservationRejected"
    description: Published when a reservation is rejected through the approval flow

  publishApprovalRequestCreated:
    action: send
    channel:
      $ref: "#/channels/approval-flow"
    messages:
      - $ref: "#/channels/approval-flow/messages/approvalRequestCreated"
    description: Published when a new approval request is created

  publishDocumentGenerated:
    action: send
    channel:
      $ref: "#/channels/document-generation"
    messages:
      - $ref: "#/channels/document-generation/messages/documentGenerated"
    description: Published when a document is generated from a template

  publishNotificationSent:
    action: send
    channel:
      $ref: "#/channels/notifications"
    messages:
      - $ref: "#/channels/notifications/messages/notificationSent"
    description: Published when a notification is sent to a user

components:
  messages:
    ReservationApproved:
      name: ReservationApproved
      title: Reservation Approved Event
      summary: Event published when a reservation is approved
      contentType: application/json
      payload:
        $ref: "#/components/schemas/ReservationApprovedPayload"

    ReservationRejected:
      name: ReservationRejected
      title: Reservation Rejected Event
      summary: Event published when a reservation is rejected
      contentType: application/json
      payload:
        $ref: "#/components/schemas/ReservationRejectedPayload"

    ApprovalRequestCreated:
      name: ApprovalRequestCreated
      title: Approval Request Created Event
      summary: Event published when a new approval request is created
      contentType: application/json
      payload:
        $ref: "#/components/schemas/ApprovalRequestCreatedPayload"

    ApprovalLevelCompleted:
      name: ApprovalLevelCompleted
      title: Approval Level Completed Event
      summary: Event published when an approval level is completed
      contentType: application/json
      payload:
        $ref: "#/components/schemas/ApprovalLevelCompletedPayload"

    ApprovalFlowCompleted:
      name: ApprovalFlowCompleted
      title: Approval Flow Completed Event
      summary: Event published when an entire approval flow is completed
      contentType: application/json
      payload:
        $ref: "#/components/schemas/ApprovalFlowCompletedPayload"

    DocumentGenerated:
      name: DocumentGenerated
      title: Document Generated Event
      summary: Event published when a document is generated from a template
      contentType: application/json
      payload:
        $ref: "#/components/schemas/DocumentGeneratedPayload"

    DocumentTemplateCreated:
      name: DocumentTemplateCreated
      title: Document Template Created Event
      summary: Event published when a new document template is created
      contentType: application/json
      payload:
        $ref: "#/components/schemas/DocumentTemplateCreatedPayload"

    DocumentTemplateUpdated:
      name: DocumentTemplateUpdated
      title: Document Template Updated Event
      summary: Event published when a document template is updated
      contentType: application/json
      payload:
        $ref: "#/components/schemas/DocumentTemplateUpdatedPayload"

    NotificationSent:
      name: NotificationSent
      title: Notification Sent Event
      summary: Event published when a notification is sent to a user
      contentType: application/json
      payload:
        $ref: "#/components/schemas/NotificationSentPayload"

    NotificationTemplateCreated:
      name: NotificationTemplateCreated
      title: Notification Template Created Event
      summary: Event published when a new notification template is created
      contentType: application/json
      payload:
        $ref: "#/components/schemas/NotificationTemplateCreatedPayload"

    NotificationTemplateUpdated:
      name: NotificationTemplateUpdated
      title: Notification Template Updated Event
      summary: Event published when a notification template is updated
      contentType: application/json
      payload:
        $ref: "#/components/schemas/NotificationTemplateUpdatedPayload"

    NotificationConfigUpdated:
      name: NotificationConfigUpdated
      title: Notification Config Updated Event
      summary: Event published when notification configuration is updated
      contentType: application/json
      payload:
        $ref: "#/components/schemas/NotificationConfigUpdatedPayload"

  schemas:
    DomainEvent:
      type: object
      required:
        - eventId
        - eventType
        - aggregateId
        - aggregateType
        - eventData
        - timestamp
        - version
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique identifier for the event
        eventType:
          type: string
          description: Type of the event
        aggregateId:
          type: string
          description: ID of the aggregate that generated the event
        aggregateType:
          type: string
          description: Type of the aggregate
        eventData:
          type: object
          description: Event-specific data payload
        timestamp:
          type: string
          format: date-time
          description: When the event occurred
        version:
          type: integer
          description: Version of the event schema

    ReservationApprovedPayload:
      allOf:
        - $ref: "#/components/schemas/DomainEvent"
        - type: object
          properties:
            eventData:
              type: object
              required:
                - reservationId
                - flowId
                - approvedBy
                - approvedAt
              properties:
                reservationId:
                  type: string
                  description: ID of the approved reservation
                flowId:
                  type: string
                  description: ID of the approval flow
                approvedBy:
                  type: string
                  description: ID of the user who approved
                approvedAt:
                  type: string
                  format: date-time
                  description: When the reservation was approved
                reason:
                  type: string
                  description: Reason for approval
                variables:
                  type: object
                  description: Additional variables for document/notification generation

    ReservationRejectedPayload:
      allOf:
        - $ref: "#/components/schemas/DomainEvent"
        - type: object
          properties:
            eventData:
              type: object
              required:
                - reservationId
                - flowId
                - rejectedBy
                - rejectedAt
                - reason
              properties:
                reservationId:
                  type: string
                  description: ID of the rejected reservation
                flowId:
                  type: string
                  description: ID of the approval flow
                rejectedBy:
                  type: string
                  description: ID of the user who rejected
                rejectedAt:
                  type: string
                  format: date-time
                  description: When the reservation was rejected
                reason:
                  type: string
                  description: Reason for rejection
                variables:
                  type: object
                  description: Additional variables for document/notification generation

    ApprovalRequestCreatedPayload:
      allOf:
        - $ref: "#/components/schemas/DomainEvent"
        - type: object
          properties:
            eventData:
              type: object
              required:
                - requestId
                - reservationId
                - flowId
                - requesterId
                - currentLevel
              properties:
                requestId:
                  type: string
                  description: ID of the approval request
                reservationId:
                  type: string
                  description: ID of the reservation being requested
                flowId:
                  type: string
                  description: ID of the approval flow
                requesterId:
                  type: string
                  description: ID of the user making the request
                currentLevel:
                  type: integer
                  description: Current approval level
                variables:
                  type: object
                  description: Additional variables for processing

    ApprovalLevelCompletedPayload:
      allOf:
        - $ref: "#/components/schemas/DomainEvent"
        - type: object
          properties:
            eventData:
              type: object
              required:
                - requestId
                - levelId
                - completedBy
                - completedAt
                - action
              properties:
                requestId:
                  type: string
                  description: ID of the approval request
                levelId:
                  type: string
                  description: ID of the completed level
                completedBy:
                  type: string
                  description: ID of the user who completed the level
                completedAt:
                  type: string
                  format: date-time
                  description: When the level was completed
                action:
                  type: string
                  enum: [APPROVED, REJECTED]
                  description: Action taken on the level

    ApprovalFlowCompletedPayload:
      allOf:
        - $ref: "#/components/schemas/DomainEvent"
        - type: object
          properties:
            eventData:
              type: object
              required:
                - flowId
                - reservationId
                - finalStatus
                - completedAt
              properties:
                flowId:
                  type: string
                  description: ID of the completed flow
                reservationId:
                  type: string
                  description: ID of the reservation
                finalStatus:
                  type: string
                  enum: [APPROVED, REJECTED]
                  description: Final status of the flow
                completedAt:
                  type: string
                  format: date-time
                  description: When the flow was completed

    DocumentGeneratedPayload:
      allOf:
        - $ref: "#/components/schemas/DomainEvent"
        - type: object
          properties:
            eventData:
              type: object
              required:
                - documentId
                - templateId
                - reservationId
                - generatedBy
              properties:
                documentId:
                  type: string
                  description: ID of the generated document
                templateId:
                  type: string
                  description: ID of the template used
                reservationId:
                  type: string
                  description: ID of the related reservation
                generatedBy:
                  type: string
                  description: ID of the user who generated the document
                filePath:
                  type: string
                  description: Path to the generated file
                fileSize:
                  type: integer
                  description: Size of the generated file in bytes

    DocumentTemplateCreatedPayload:
      allOf:
        - $ref: "#/components/schemas/DomainEvent"
        - type: object
          properties:
            eventData:
              type: object
              required:
                - templateId
                - name
                - createdBy
              properties:
                templateId:
                  type: string
                  description: ID of the created template
                name:
                  type: string
                  description: Name of the template
                createdBy:
                  type: string
                  description: ID of the user who created the template

    DocumentTemplateUpdatedPayload:
      allOf:
        - $ref: "#/components/schemas/DomainEvent"
        - type: object
          properties:
            eventData:
              type: object
              required:
                - templateId
                - updatedBy
              properties:
                templateId:
                  type: string
                  description: ID of the updated template
                updatedBy:
                  type: string
                  description: ID of the user who updated the template

    NotificationSentPayload:
      allOf:
        - $ref: "#/components/schemas/DomainEvent"
        - type: object
          properties:
            eventData:
              type: object
              required:
                - notificationId
                - templateId
                - recipientId
                - channel
                - status
              properties:
                notificationId:
                  type: string
                  description: ID of the sent notification
                templateId:
                  type: string
                  description: ID of the template used
                recipientId:
                  type: string
                  description: ID of the recipient
                channel:
                  type: string
                  enum: [EMAIL, SMS, IN_APP, PUSH]
                  description: Channel used for notification
                status:
                  type: string
                  enum: [PENDING, SENT, DELIVERED, FAILED]
                  description: Status of the notification

    NotificationTemplateCreatedPayload:
      allOf:
        - $ref: "#/components/schemas/DomainEvent"
        - type: object
          properties:
            eventData:
              type: object
              required:
                - templateId
                - name
                - eventType
                - createdBy
              properties:
                templateId:
                  type: string
                  description: ID of the created template
                name:
                  type: string
                  description: Name of the template
                eventType:
                  type: string
                  description: Event type the template handles
                createdBy:
                  type: string
                  description: ID of the user who created the template

    NotificationTemplateUpdatedPayload:
      allOf:
        - $ref: "#/components/schemas/DomainEvent"
        - type: object
          properties:
            eventData:
              type: object
              required:
                - templateId
                - updatedBy
              properties:
                templateId:
                  type: string
                  description: ID of the updated template
                updatedBy:
                  type: string
                  description: ID of the user who updated the template

    NotificationConfigUpdatedPayload:
      allOf:
        - $ref: "#/components/schemas/DomainEvent"
        - type: object
          properties:
            eventData:
              type: object
              required:
                - configId
                - programId
                - updatedBy
              properties:
                configId:
                  type: string
                  description: ID of the updated configuration
                programId:
                  type: string
                  description: ID of the program
                updatedBy:
                  type: string
                  description: ID of the user who updated the configuration
