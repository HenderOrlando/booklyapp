# Configuración Alertmanager para Bookly Backend
# Gestión de alertas y notificaciones

global:
  # Configuración global de SMTP
  smtp_smarthost: 'localhost:587'
  smtp_from: 'alerts@bookly.ufps.edu.co'
  smtp_auth_username: ''
  smtp_auth_password: ''
  smtp_require_tls: false

# Plantillas de alertas
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Configuración de rutas
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'web.hook.default'
  routes:
    # Alertas críticas - notificación inmediata
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 5m

    # Alertas de warning - agrupadas
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 30m

    # Alertas de servicios específicos
    - match:
        service: auth-service
      receiver: 'auth-service-alerts'

    - match:
        service: resources-service
      receiver: 'resources-service-alerts'

    - match:
        service: availability-service
      receiver: 'availability-service-alerts'

    - match:
        service: stockpile-service
      receiver: 'stockpile-service-alerts'

    - match:
        service: reports-service
      receiver: 'reports-service-alerts'

    # Alertas de base de datos
    - match:
        component: database
      receiver: 'database-alerts'
      repeat_interval: 15m

# Configuración de inhibición
inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'cluster', 'service']

# Configuración de receptores
receivers:
  - name: 'web.hook.default'
    webhook_configs:
      - url: 'http://localhost:5001/webhook'
        send_resolved: true

  - name: 'critical-alerts'
    email_configs:
      - to: 'admin@ufps.edu.co'
        subject: '[CRITICAL] Bookly Alert: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        body: |
          {{ range .Alerts }}
          **Alert:** {{ .Annotations.summary }}
          
          **Description:** {{ .Annotations.description }}
          
          **Service:** {{ .Labels.service }}
          **Instance:** {{ .Labels.instance }}
          **Severity:** {{ .Labels.severity }}
          
          **Time:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          **Labels:**
          {{ range .Labels.SortedPairs }}
          - {{ .Name }}: {{ .Value }}
          {{ end }}
          {{ end }}

    webhook_configs:
      - url: 'http://stockpile-service:3004/webhooks/alerts/critical'
        send_resolved: true

  - name: 'warning-alerts'
    email_configs:
      - to: 'support@ufps.edu.co'
        subject: '[WARNING] Bookly Alert: {{ .GroupLabels.alertname }}'
        body: |
          **Grupo de Alertas:** {{ .GroupLabels.alertname }}
          
          **Total de Alertas:** {{ len .Alerts }}
          
          {{ range .Alerts }}
          ---
          **Alert:** {{ .Annotations.summary }}
          **Service:** {{ .Labels.service }}
          **Instance:** {{ .Labels.instance }}
          **Time:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  - name: 'auth-service-alerts'
    email_configs:
      - to: 'auth-team@ufps.edu.co'
        subject: '[AUTH] Bookly Alert: {{ .GroupLabels.alertname }}'
        body: |
          **Servicio:** Auth Service
          {{ range .Alerts }}
          **Alert:** {{ .Annotations.summary }}
          **Description:** {{ .Annotations.description }}
          **Time:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  - name: 'resources-service-alerts'
    email_configs:
      - to: 'resources-team@ufps.edu.co'
        subject: '[RESOURCES] Bookly Alert: {{ .GroupLabels.alertname }}'

  - name: 'availability-service-alerts'
    email_configs:
      - to: 'availability-team@ufps.edu.co'
        subject: '[AVAILABILITY] Bookly Alert: {{ .GroupLabels.alertname }}'

  - name: 'stockpile-service-alerts'
    email_configs:
      - to: 'approvals-team@ufps.edu.co'
        subject: '[STOCKPILE] Bookly Alert: {{ .GroupLabels.alertname }}'

  - name: 'reports-service-alerts'
    email_configs:
      - to: 'reports-team@ufps.edu.co'
        subject: '[REPORTS] Bookly Alert: {{ .GroupLabels.alertname }}'

  - name: 'database-alerts'
    email_configs:
      - to: 'dba@ufps.edu.co'
        subject: '[DATABASE] Bookly Alert: {{ .GroupLabels.alertname }}'
        body: |
          **Database Alert**
          
          {{ range .Alerts }}
          **Alert:** {{ .Annotations.summary }}
          **Description:** {{ .Annotations.description }}
          **Database:** {{ .Labels.database }}
          **Instance:** {{ .Labels.instance }}
          **Time:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          **Runbook:** {{ .Annotations.runbook_url }}
          {{ end }}

# Configuración de tiempo de espera
time_intervals:
  - name: 'working-hours'
    time_intervals:
      - times:
          - start_time: '08:00'
            end_time: '18:00'
        weekdays: ['monday:friday']
        months: ['january:december']
        days_of_month: ['1:31']

  - name: 'business-days'
    time_intervals:
      - weekdays: ['monday:friday']
        months: ['january:december']
