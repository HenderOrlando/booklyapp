# Servicios base para Bookly Backend: MongoDB, Redis, RabbitMQ
# Configuración optimizada para desarrollo y producción

services:
  # MongoDB Replica Set (3 nodos para alta disponibilidad)
  mongodb-primary:
    image: mongo:7.0
    container_name: bookly-mongodb-primary
    hostname: mongodb-primary
    restart: unless-stopped
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -e
        mkdir -p /opt/keyfile
        if [ -f /host-keyfile/mongodb-keyfile ]; then
          cp /host-keyfile/mongodb-keyfile /opt/keyfile/mongodb-keyfile
          chmod 400 /opt/keyfile/mongodb-keyfile
          chown mongodb:mongodb /opt/keyfile/mongodb-keyfile
        else
          echo "ERROR: Keyfile no encontrado en /host-keyfile/mongodb-keyfile"
          exit 1
        fi
        exec docker-entrypoint.sh mongod --replSet bookly-rs --bind_ip_all --keyFile /opt/keyfile/mongodb-keyfile --auth
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_ROOT_USERNAME:-bookly}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_ROOT_PASSWORD:-bookly123}
      MONGO_INITDB_DATABASE: ${MONGODB_DATABASE:-bookly}
    ports:
      - "27017:27017"
    volumes:
      - mongodb_primary_data:/data/db
      - mongodb_primary_config:/data/configdb
      - ./mongodb/keyfile:/host-keyfile:ro
      - ./mongodb/init-replica.js:/docker-entrypoint-initdb.d/init-replica.js:ro
    networks:
      - bookly-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  mongodb-secondary1:
    image: mongo:7.0
    container_name: bookly-mongodb-secondary1
    hostname: mongodb-secondary1
    restart: unless-stopped
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -e
        mkdir -p /opt/keyfile
        if [ -f /host-keyfile/mongodb-keyfile ]; then
          cp /host-keyfile/mongodb-keyfile /opt/keyfile/mongodb-keyfile
          chmod 400 /opt/keyfile/mongodb-keyfile
          chown mongodb:mongodb /opt/keyfile/mongodb-keyfile
        else
          echo "ERROR: Keyfile no encontrado en /host-keyfile/mongodb-keyfile"
          exit 1
        fi
        exec docker-entrypoint.sh mongod --replSet bookly-rs --bind_ip_all --port 27018 --keyFile /opt/keyfile/mongodb-keyfile --auth
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_ROOT_USERNAME:-bookly}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_ROOT_PASSWORD:-bookly123}
    ports:
      - "27018:27018"
    volumes:
      - mongodb_secondary1_data:/data/db
      - mongodb_secondary1_config:/data/configdb
      - ./mongodb/keyfile:/host-keyfile:ro
    networks:
      - bookly-network
    depends_on:
      - mongodb-primary
    healthcheck:
      test:
        [
          "CMD",
          "mongosh",
          "--host",
          "localhost",
          "--port",
          "27018",
          "--eval",
          "db.adminCommand('ping')",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  mongodb-secondary2:
    image: mongo:7.0
    container_name: bookly-mongodb-secondary2
    hostname: mongodb-secondary2
    restart: unless-stopped
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -e
        mkdir -p /opt/keyfile
        if [ -f /host-keyfile/mongodb-keyfile ]; then
          cp /host-keyfile/mongodb-keyfile /opt/keyfile/mongodb-keyfile
          chmod 400 /opt/keyfile/mongodb-keyfile
          chown mongodb:mongodb /opt/keyfile/mongodb-keyfile
        else
          echo "ERROR: Keyfile no encontrado en /host-keyfile/mongodb-keyfile"
          exit 1
        fi
        exec docker-entrypoint.sh mongod --replSet bookly-rs --bind_ip_all --port 27019 --keyFile /opt/keyfile/mongodb-keyfile --auth
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_ROOT_USERNAME:-bookly}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_ROOT_PASSWORD:-bookly123}
    ports:
      - "27019:27019"
    volumes:
      - mongodb_secondary2_data:/data/db
      - mongodb_secondary2_config:/data/configdb
      - ./mongodb/keyfile:/host-keyfile:ro
    networks:
      - bookly-network
    depends_on:
      - mongodb-primary
    healthcheck:
      test:
        [
          "CMD",
          "mongosh",
          "--host",
          "localhost",
          "--port",
          "27019",
          "--eval",
          "db.adminCommand('ping')",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  # Redis para cache y sesiones
  redis:
    image: redis:7.2-alpine
    container_name: bookly-redis
    hostname: redis
    restart: unless-stopped
    command: [
        "redis-server",
        "--requirepass",
        "${REDIS_PASSWORD:-bookly123}",
        "--appendonly",
        "yes",
        "--appendfsync",
        "everysec",
        "--maxmemory",
        "512mb",
        "--maxmemory-policy",
        "allkeys-lru",
        # TCP keepalive for stable connections
        "--tcp-keepalive",
        "60",
        # Timeout for idle clients (0 = never timeout)
        "--timeout",
        "0",
        # Max number of clients
        "--maxclients",
        "10000",
        # TCP backlog
        "--tcp-backlog",
        "511",
      ]
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD:-bookly123}
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    networks:
      - bookly-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  # RabbitMQ para Event-Driven Architecture
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: bookly-rabbitmq
    hostname: rabbitmq
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USERNAME:-bookly}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-bookly123}
      RABBITMQ_DEFAULT_VHOST: ${RABBITMQ_VHOST:-bookly}
      RABBITMQ_ERLANG_COOKIE: ${RABBITMQ_ERLANG_COOKIE:-bookly-cookie-secret}
    ports:
      - "5672:5672" # AMQP port
      - "15672:15672" # Management UI
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
      - ./rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      - ./rabbitmq/definitions.json:/etc/rabbitmq/definitions.json:ro
    networks:
      - bookly-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "rabbitmq-diagnostics check_port_connectivity && rabbitmq-diagnostics check_running && rabbitmq-diagnostics check_local_alarms",
        ]
      interval: 15s
      timeout: 15s
      retries: 15
      start_period: 120s # RabbitMQ needs more time for all boot steps

  # Nginx como reverse proxy - Recibe tráfico HTTP del Load Balancer
  # Load Balancer maneja SSL, Nginx solo recibe HTTP en puerto 80
  nginx:
    image: nginx:1.25-alpine
    container_name: bookly-nginx
    hostname: nginx
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - "80:80" # HTTP - Load Balancer envía tráfico aquí
      - "8080:8080" # Management port (opcional)
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    networks:
      - bookly-network
    depends_on:
      - mongodb-primary
      - redis
      - rabbitmq
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:8080/health || true",
        ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Inicializador automático del replica set MongoDB
  mongodb-init:
    image: mongo:7.0
    container_name: bookly-mongodb-init
    hostname: mongodb-init
    restart: "no" # Solo ejecutar una vez
    command: ["/bin/bash", "/scripts/init-replica-auto.sh"]
    volumes:
      - ./mongodb/init-replica-auto.sh:/scripts/init-replica-auto.sh:ro
    networks:
      - bookly-network
    depends_on:
      mongodb-primary:
        condition: service_healthy
      mongodb-secondary1:
        condition: service_healthy
      mongodb-secondary2:
        condition: service_healthy
    environment:
      - MONGODB_ROOT_USERNAME=${MONGODB_ROOT_USERNAME:-bookly}
      - MONGODB_ROOT_PASSWORD=${MONGODB_ROOT_PASSWORD:-bookly123}

# Volúmenes persistentes
volumes:
  mongodb_primary_data:
    driver: local
  mongodb_primary_config:
    driver: local
  mongodb_secondary1_data:
    driver: local
  mongodb_secondary1_config:
    driver: local
  mongodb_secondary2_data:
    driver: local
  mongodb_secondary2_config:
    driver: local
  redis_data:
    driver: local
  rabbitmq_data:
    driver: local
  nginx_logs:
    driver: local

# Red para comunicación entre servicios
networks:
  bookly-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
