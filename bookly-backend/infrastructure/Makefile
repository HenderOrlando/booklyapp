# =============================================================================
# Bookly Backend Infrastructure - Makefile
# Comandos r√°pidos para gesti√≥n Docker
# =============================================================================

.PHONY: help init dev-start dev-stop dev-restart dev-status dev-logs dev-clean
.PHONY: start stop restart status logs build clean reset backup seed health
.PHONY: base observability microservices all
.PHONY: shell exec mongodb redis rabbitmq nginx
.DEFAULT_GOAL := help

# Configuraci√≥n
DOCKER_SCRIPT := ./scripts/bookly-docker.sh
DEV_SCRIPT := ./scripts/setup-dev.sh

# =============================================================================
# AYUDA
# =============================================================================

help: ## Mostrar ayuda
	@echo "üîß Bookly Backend Infrastructure - Makefile"
	@echo ""
	@echo "COMANDOS PRINCIPALES:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "EJEMPLOS:"
	@echo "  make dev-start     # Iniciar desarrollo"
	@echo "  make logs          # Ver todos los logs"
	@echo "  make shell s=redis # Shell de Redis"
	@echo "  make health        # Verificar salud"

# =============================================================================
# DESARROLLO R√ÅPIDO
# =============================================================================

dev-setup: ## Configuraci√≥n inicial para desarrollo
	@echo "üöÄ Configurando entorno de desarrollo..."
	@$(DEV_SCRIPT)

dev-start: ## Iniciar servicios base para desarrollo
	@echo "‚ñ∂Ô∏è  Iniciando servicios base..."
	@$(DOCKER_SCRIPT) start base

dev-stop: ## Detener servicios de desarrollo
	@echo "‚èπÔ∏è  Deteniendo servicios base..."
	@$(DOCKER_SCRIPT) stop base

dev-restart: dev-stop dev-start ## Reiniciar servicios de desarrollo

dev-status: ## Estado de servicios de desarrollo
	@$(DOCKER_SCRIPT) status

dev-logs: ## Logs de servicios de desarrollo
	@$(DOCKER_SCRIPT) logs

dev-clean: ## Limpiar servicios de desarrollo
	@echo "üßπ Limpiando servicios de desarrollo..."
	@$(DOCKER_SCRIPT) clean

dev-fix-mongo: ## Fix del keyfile de MongoDB y reiniciar
	@echo "üîß Aplicando fix de MongoDB keyfile..."
	@chmod +x scripts/fix-mongodb-keyfile.sh
	@bash scripts/fix-mongodb-keyfile.sh
	@echo "üîÑ Reiniciando MongoDB..."
	@docker compose -f docker-compose.base.yml restart mongodb-primary mongodb-secondary1 mongodb-secondary2
	@echo "‚úÖ Fix aplicado. Verifica logs con: make logs s=mongodb-primary"

dev-fix-rabbitmq: ## Fix de RabbitMQ - Recarga definiciones y vhost
	@echo "üê∞ Aplicando fix de RabbitMQ..."
	@echo "‚ö†Ô∏è  IMPORTANTE: Esto eliminar√° el volumen de RabbitMQ"
	@echo "üõë Deteniendo RabbitMQ..."
	@docker compose -f docker-compose.base.yml stop rabbitmq
	@echo "üóëÔ∏è  Eliminando volumen de RabbitMQ..."
	@docker volume rm bookly_rabbitmq_data 2>/dev/null || echo "Volumen no existe"
	@echo "üöÄ Iniciando RabbitMQ con nuevas definiciones..."
	@docker compose -f docker-compose.base.yml up -d rabbitmq
	@echo "‚è≥ Esperando a que RabbitMQ est√© listo (60s)..."
	@sleep 60
	@echo "‚úÖ RabbitMQ reiniciado con nuevas configuraciones"
	@echo "üîç Verificando vhost:"
	@docker exec bookly-rabbitmq rabbitmqctl list_vhosts
	@echo "üîç Verificando permisos:"
	@docker exec bookly-rabbitmq rabbitmqctl list_permissions -p bookly
	@echo "‚úÖ Fix completado. Ahora reinicia los microservicios con: make microservices-restart"

# =============================================================================
# GESTI√ìN DE MICROSERVICIOS
# =============================================================================

microservices: ## Iniciar microservicios (requiere servicios base)
	@echo "üöÄ Iniciando microservicios..."
	@docker network inspect bookly-network >/dev/null 2>&1 || \
		(echo "‚ö†Ô∏è  Red bookly-network no existe. Iniciando servicios base primero..." && $(MAKE) dev-start)
	@docker compose -f docker-compose.microservices.yml up -d
	@echo "‚úÖ Microservicios iniciados"
	@echo "üìä Ver estado: make status"

microservices-stop: ## Detener microservicios
	@echo "‚èπÔ∏è  Deteniendo microservicios..."
	@docker compose -f docker-compose.microservices.yml down
	@echo "‚úÖ Microservicios detenidos"

microservices-restart: microservices-stop microservices ## Reiniciar microservicios

microservices-logs: ## Ver logs de microservicios
	@docker compose -f docker-compose.microservices.yml logs -f

dev-full: ## Iniciar servicios base + microservicios (todo en uno)
	@echo "üöÄ Iniciando stack completo (base + microservicios)..."
	@docker compose -f docker-compose.dev.yml up -d
	@echo "‚úÖ Stack completo iniciado"
	@echo "üìä Ver estado: docker ps"
	@echo "üìã Ver logs: make logs"

dev-full-stop: ## Detener stack completo
	@echo "‚èπÔ∏è  Deteniendo stack completo..."
	@docker compose -f docker-compose.dev.yml down
	@echo "‚úÖ Stack completo detenido"

dev-full-logs: ## Ver logs del stack completo
	@docker compose -f docker-compose.dev.yml logs -f

dev-full-restart: dev-full-stop dev-full ## Reiniciar stack completo

# =============================================================================
# GESTI√ìN DE SERVICIOS INDIVIDUALES
# =============================================================================

## Servicios Base

# MongoDB Primary
mongodb-primary-start: ## Iniciar MongoDB Primary
	@docker compose -f docker-compose.base.yml up -d mongodb-primary

mongodb-primary-stop: ## Detener MongoDB Primary
	@docker compose -f docker-compose.base.yml stop mongodb-primary

mongodb-primary-logs: ## Ver logs de MongoDB Primary
	@docker logs bookly-mongodb-primary -f

mongodb-primary-restart: mongodb-primary-stop mongodb-primary-start ## Reiniciar MongoDB Primary

# Redis
redis-start: ## Iniciar Redis
	@docker compose -f docker-compose.base.yml up -d redis

redis-stop: ## Detener Redis
	@docker compose -f docker-compose.base.yml stop redis

redis-logs: ## Ver logs de Redis
	@docker logs bookly-redis -f

redis-restart: redis-stop redis-start ## Reiniciar Redis

# RabbitMQ
rabbitmq-start: ## Iniciar RabbitMQ
	@docker compose -f docker-compose.base.yml up -d rabbitmq

rabbitmq-stop: ## Detener RabbitMQ
	@docker compose -f docker-compose.base.yml stop rabbitmq

rabbitmq-logs: ## Ver logs de RabbitMQ
	@docker logs bookly-rabbitmq -f

rabbitmq-restart: rabbitmq-stop rabbitmq-start ## Reiniciar RabbitMQ

## Microservicios

# API Gateway
api-gateway-start: ## Iniciar API Gateway
	@docker compose -f docker-compose.microservices.yml up -d api-gateway

api-gateway-stop: ## Detener API Gateway
	@docker compose -f docker-compose.microservices.yml stop api-gateway

api-gateway-logs: ## Ver logs de API Gateway
	@docker logs bookly-api-gateway -f

api-gateway-restart: api-gateway-stop api-gateway-start ## Reiniciar API Gateway

# Auth Service
auth-start: ## Iniciar Auth Service
	@docker compose -f docker-compose.microservices.yml up -d auth-service

auth-stop: ## Detener Auth Service
	@docker compose -f docker-compose.microservices.yml stop auth-service

auth-logs: ## Ver logs de Auth Service
	@docker logs bookly-auth-service -f

auth-restart: auth-stop auth-start ## Reiniciar Auth Service

# Resources Service
resources-start: ## Iniciar Resources Service
	@docker compose -f docker-compose.microservices.yml up -d resources-service

resources-stop: ## Detener Resources Service
	@docker compose -f docker-compose.microservices.yml stop resources-service

resources-logs: ## Ver logs de Resources Service
	@docker logs bookly-resources-service -f

resources-restart: resources-stop resources-start ## Reiniciar Resources Service

# Availability Service
availability-start: ## Iniciar Availability Service
	@docker compose -f docker-compose.microservices.yml up -d availability-service

availability-stop: ## Detener Availability Service
	@docker compose -f docker-compose.microservices.yml stop availability-service

availability-logs: ## Ver logs de Availability Service
	@docker logs bookly-availability-service -f

availability-restart: availability-stop availability-start ## Reiniciar Availability Service

# Stockpile Service
stockpile-start: ## Iniciar Stockpile Service
	@docker compose -f docker-compose.microservices.yml up -d stockpile-service

stockpile-stop: ## Detener Stockpile Service
	@docker compose -f docker-compose.microservices.yml stop stockpile-service

stockpile-logs: ## Ver logs de Stockpile Service
	@docker logs bookly-stockpile-service -f

stockpile-restart: stockpile-stop stockpile-start ## Reiniciar Stockpile Service

# Reports Service
reports-start: ## Iniciar Reports Service
	@docker compose -f docker-compose.microservices.yml up -d reports-service

reports-stop: ## Detener Reports Service
	@docker compose -f docker-compose.microservices.yml stop reports-service

reports-logs: ## Ver logs de Reports Service
	@docker logs bookly-reports-service -f

reports-restart: reports-stop reports-start ## Reiniciar Reports Service

# =============================================================================
# GESTI√ìN DE NGINX
# =============================================================================

nginx-start: ## Iniciar Nginx (verifica microservicios)
	@chmod +x scripts/manage-nginx.sh
	@bash scripts/manage-nginx.sh start

nginx-stop: ## Detener Nginx
	@chmod +x scripts/manage-nginx.sh
	@bash scripts/manage-nginx.sh stop

nginx-restart: ## Reiniciar Nginx
	@chmod +x scripts/manage-nginx.sh
	@bash scripts/manage-nginx.sh restart

nginx-status: ## Ver estado de Nginx y microservicios
	@chmod +x scripts/manage-nginx.sh
	@bash scripts/manage-nginx.sh status

nginx-logs: ## Ver logs de Nginx en tiempo real
	@chmod +x scripts/manage-nginx.sh
	@bash scripts/manage-nginx.sh logs

nginx-errors: ## Buscar errores en logs de Nginx
	@chmod +x scripts/manage-nginx.sh
	@bash scripts/manage-nginx.sh errors

# =============================================================================
# GESTI√ìN COMPLETA
# =============================================================================

init: ## Inicializar configuraci√≥n completa
	@echo "üîß Inicializando configuraci√≥n..."
	@$(DOCKER_SCRIPT) init

start: ## Iniciar todos los servicios
	@echo "‚ñ∂Ô∏è  Iniciando todos los servicios..."
	@$(DOCKER_SCRIPT) start

stop: ## Detener todos los servicios
	@echo "‚èπÔ∏è  Deteniendo todos los servicios..."
	@$(DOCKER_SCRIPT) stop

restart: stop start ## Reiniciar todos los servicios

status: ## Mostrar estado de todos los servicios
	@$(DOCKER_SCRIPT) status

logs: ## Mostrar logs de todos los servicios
	@$(DOCKER_SCRIPT) logs $(s)

build: ## Construir im√°genes de microservicios
	@echo "üî® Construyendo im√°genes..."
	@$(DOCKER_SCRIPT) build

clean: ## Limpiar contenedores y vol√∫menes
	@echo "üßπ Limpiando servicios..."
	@$(DOCKER_SCRIPT) clean $(if $(force),--force)

reset: ## Reset completo (CUIDADO: elimina todos los datos)
	@echo "üí£ Reset completo..."
	@$(DOCKER_SCRIPT) reset $(if $(force),--force)

# =============================================================================
# STACKS ESPEC√çFICOS
# =============================================================================

base: ## Iniciar solo servicios base (MongoDB, Redis, RabbitMQ)
	@echo "‚ñ∂Ô∏è  Iniciando servicios base..."
	@$(DOCKER_SCRIPT) start base

observability: ## Iniciar solo servicios de observabilidad
	@echo "‚ñ∂Ô∏è  Iniciando observabilidad..."
	@$(DOCKER_SCRIPT) start observability

microservices: ## Iniciar solo microservicios
	@echo "‚ñ∂Ô∏è  Iniciando microservicios..."
	@$(DOCKER_SCRIPT) start microservices

all: base observability microservices ## Iniciar todos los stacks secuencialmente

# =============================================================================
# GESTI√ìN DE DATOS
# =============================================================================

backup: ## Crear backup de datos
	@echo "üíæ Creando backup..."
	@$(DOCKER_SCRIPT) backup

seed: ## Ejecutar semillas de base de datos
	@echo "üå± Ejecutando semillas..."
	@$(DOCKER_SCRIPT) seed

health: ## Verificar salud de servicios
	@echo "üè• Verificando salud..."
	@$(DOCKER_SCRIPT) health

# =============================================================================
# ACCESO A SERVICIOS
# =============================================================================

shell: ## Acceder a shell de un servicio (uso: make shell s=redis)
	@if [ -z "$(s)" ]; then \
		echo "‚ùå Especifica el servicio: make shell s=<servicio>"; \
		echo "Servicios disponibles: mongodb-primary, redis, rabbitmq, auth-service, etc."; \
	else \
		echo "üêö Accediendo a shell de $(s)..."; \
		$(DOCKER_SCRIPT) shell $(s); \
	fi

exec: ## Ejecutar comando en servicio (uso: make exec s=redis c="redis-cli info")
	@if [ -z "$(s)" ] || [ -z "$(c)" ]; then \
		echo "‚ùå Especifica servicio y comando: make exec s=<servicio> c=\"<comando>\""; \
	else \
		echo "‚ö° Ejecutando '$(c)' en $(s)..."; \
		$(DOCKER_SCRIPT) exec $(s) $(c); \
	fi

# =============================================================================
# ACCESOS R√ÅPIDOS A SERVICIOS ESPEC√çFICOS
# =============================================================================

mongodb: ## Shell de MongoDB
	@$(DOCKER_SCRIPT) shell mongodb-primary

redis: ## Shell de Redis
	@$(DOCKER_SCRIPT) shell redis

rabbitmq: ## Shell de RabbitMQ
	@$(DOCKER_SCRIPT) shell rabbitmq

nginx: ## Shell de Nginx
	@$(DOCKER_SCRIPT) shell nginx

auth: ## Shell de Auth Service
	@$(DOCKER_SCRIPT) shell auth-service

resources: ## Shell de Resources Service
	@$(DOCKER_SCRIPT) shell resources-service

# =============================================================================
# COMANDOS DE DIAGN√ìSTICO
# =============================================================================

ps: ## Mostrar contenedores Docker
	@docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep bookly || echo "No hay contenedores Bookly ejecut√°ndose"

images: ## Mostrar im√°genes Docker de Bookly
	@docker images bookly/* --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"

networks: ## Mostrar redes Docker de Bookly
	@docker network ls | grep bookly

volumes: ## Mostrar vol√∫menes Docker de Bookly
	@docker volume ls | grep bookly

stats: ## Mostrar estad√≠sticas de recursos
	@docker stats --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}" --no-stream | grep bookly

errors: ## Mostrar errores en logs
	@echo "üîç Buscando errores en logs..."
	@$(DOCKER_SCRIPT) logs | grep -i error | tail -20 || echo "No se encontraron errores recientes"

# =============================================================================
# UTILIDADES DE DESARROLLO
# =============================================================================

mongo-cli: ## Cliente MongoDB
	@$(DOCKER_SCRIPT) exec mongodb-primary mongosh --username bookly --password bookly123 --authenticationDatabase admin bookly

redis-cli: ## Cliente Redis
	@$(DOCKER_SCRIPT) exec redis redis-cli -a bookly123

rabbit-admin: ## Abrir RabbitMQ Management en navegador
	@echo "üê∞ Abriendo RabbitMQ Management..."
	@echo "URL: http://localhost:15672"
	@echo "Usuario: bookly / Contrase√±a: bookly123"
	@open http://localhost:15672 2>/dev/null || echo "Abre manualmente: http://localhost:15672"

signoz: ## Abrir SigNoz en navegador
	@echo "üìä Abriendo SigNoz..."
	@echo "URL: http://localhost:3301"
	@open http://localhost:3301 2>/dev/null || echo "Abre manualmente: http://localhost:3301"

sentry: ## Abrir Sentry en navegador
	@echo "üêõ Abriendo Sentry..."
	@echo "URL: http://localhost:9001"
	@echo "Usuario: admin@bookly.local / Contrase√±a: admin123"
	@open http://localhost:9001 2>/dev/null || echo "Abre manualmente: http://localhost:9001"

# =============================================================================
# COMANDOS DE PRUEBAS
# =============================================================================

test-connections: ## Probar conexiones a servicios
	@echo "üîå Probando conexiones..."
	@echo "MongoDB:" && nc -z localhost 27017 && echo "‚úÖ OK" || echo "‚ùå FAIL"
	@echo "Redis:" && nc -z localhost 6379 && echo "‚úÖ OK" || echo "‚ùå FAIL"
	@echo "RabbitMQ:" && nc -z localhost 5672 && echo "‚úÖ OK" || echo "‚ùå FAIL"
	@echo "API Gateway:" && nc -z localhost 80 && echo "‚úÖ OK" || echo "‚ùå FAIL"

ping-services: ## Ping a todos los servicios
	@echo "üèì Ping a servicios..."
	@for service in auth-service resources-service availability-service stockpile-service reports-service; do \
		echo -n "$$service: "; \
		curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/health || echo "‚ùå"; \
	done

# =============================================================================
# INFORMACI√ìN √öTIL
# =============================================================================

info: ## Mostrar informaci√≥n de configuraci√≥n
	@echo "üìã Informaci√≥n de Configuraci√≥n Bookly"
	@echo ""
	@echo "üóÇÔ∏è  Archivos:"
	@echo "   ‚Ä¢ Configuraci√≥n: .env.docker"
	@echo "   ‚Ä¢ Base: docker-compose.base.yml"
	@echo "   ‚Ä¢ Observabilidad: docker-compose.observability.yml"
	@echo "   ‚Ä¢ Microservicios: docker-compose.microservices.yml"
	@echo ""
	@echo "üîó URLs de Acceso:"
	@echo "   ‚Ä¢ API Gateway: http://localhost"
	@echo "   ‚Ä¢ Management: http://localhost:8080"
	@echo "   ‚Ä¢ RabbitMQ: http://localhost:15672"
	@echo "   ‚Ä¢ SigNoz: http://localhost:3301"
	@echo "   ‚Ä¢ Sentry: http://localhost:9001"
	@echo ""
	@echo "üîê Credenciales por Defecto:"
	@echo "   ‚Ä¢ MongoDB: bookly / bookly123"
	@echo "   ‚Ä¢ Redis: bookly123"
	@echo "   ‚Ä¢ RabbitMQ: bookly / bookly123"

urls: ## Mostrar todas las URLs importantes
	@echo "üîó URLs de Servicios Bookly:"
	@echo ""
	@echo "üì° API y Servicios:"
	@echo "   ‚Ä¢ API Gateway:        http://localhost"
	@echo "   ‚Ä¢ API Management:     http://localhost:8080"
	@echo "   ‚Ä¢ Auth Service:       http://localhost:3001"
	@echo "   ‚Ä¢ Resources Service:  http://localhost:3002"
	@echo "   ‚Ä¢ Availability:       http://localhost:3003"
	@echo "   ‚Ä¢ Stockpile:          http://localhost:3004"
	@echo "   ‚Ä¢ Reports:            http://localhost:3005"
	@echo ""
	@echo "üóÑÔ∏è  Bases de Datos:"
	@echo "   ‚Ä¢ MongoDB:            mongodb://localhost:27017,27018,27019"
	@echo "   ‚Ä¢ Redis:              redis://localhost:6379"
	@echo "   ‚Ä¢ RabbitMQ:           amqp://localhost:5672"
	@echo "   ‚Ä¢ ClickHouse:         http://localhost:8123"
	@echo ""
	@echo "üìä Observabilidad:"
	@echo "   ‚Ä¢ RabbitMQ Mgmt:      http://localhost:15672"
	@echo "   ‚Ä¢ SigNoz:             http://localhost:3301"
	@echo "   ‚Ä¢ Sentry:             http://localhost:9001"
	@echo "   ‚Ä¢ Alertmanager:       http://localhost:9093"

# =============================================================================
# VARIABLES PARA COMANDOS
# =============================================================================

# Variables que se pueden usar:
# s = servicio (para shell y exec)
# c = comando (para exec)
# force = forzar operaci√≥n (para clean y reset)

# =============================================================================
# FIXES Y DIAGN√ìSTICO
# =============================================================================

dev-fix-host-binding: ## Aplicar fix de host binding (localhost ‚Üí 0.0.0.0)
	@echo "üîß Aplicando fix de host binding..."
	@chmod +x scripts/apply-host-binding-fix.sh
	@./scripts/apply-host-binding-fix.sh

dev-fix-redis-health: ## Aplicar fix de Redis health check (result: null)
	@echo "üîß Aplicando fix de Redis health check..."
	@chmod +x scripts/apply-redis-health-fix.sh
	@./scripts/apply-redis-health-fix.sh

dev-fix-redis-stability: ## Aplicar fix de estabilidad Redis (desconexiones frecuentes)
	@echo "üîß Aplicando fix de estabilidad Redis..."
	@chmod +x scripts/apply-redis-stability-fix.sh
	@./scripts/apply-redis-stability-fix.sh

dev-fix-rabbitmq-boot: ## Aplicar fix de inicializaci√≥n RabbitMQ (boot steps lentos)
	@echo "üê∞ Aplicando fix de RabbitMQ (boot steps)..."
	@echo "üìã Paso 1: Rebuilding microservicios..."
	@docker compose -f docker-compose.microservices.yml build
	@echo "üìã Paso 2: Recreando RabbitMQ..."
	@docker compose -p bookly -f docker-compose.base.yml stop rabbitmq
	@docker rm bookly-rabbitmq || true
	@docker compose -p bookly -f docker-compose.base.yml up -d rabbitmq
	@echo "‚è≥ Esperando 120 segundos para boot steps..."
	@sleep 120
	@echo "üìã Paso 3: Reiniciando microservicios..."
	@docker compose -p bookly -f docker-compose.microservices.yml down
	@docker compose -p bookly -f docker-compose.microservices.yml up -d
	@sleep 30
	@echo "‚úÖ Fix de RabbitMQ aplicado"
	@echo "üîç Verificar con: curl -s http://localhost:3001/api/v1/health | jq .info.rabbitmq"

dev-fix-service-ports: ## Aplicar fix de puertos incorrectos (resources:3002, availability:3003)
	@echo "üîß Aplicando fix de puertos de microservicios..."
	@chmod +x scripts/fix-service-ports.sh
	@./scripts/fix-service-ports.sh

dev-diagnose: ## Diagn√≥stico completo de microservicios
	@echo "üîç Ejecutando diagn√≥stico..."
	@chmod +x scripts/check-microservices-logs.sh
	@./scripts/check-microservices-logs.sh

dev-security-check: ## Ver intentos de ataque (path traversal, etc)
	@echo "üõ°Ô∏è Revisando intentos de ataque..."
	@echo ""
	@echo "üìä Path Traversal attempts (√∫ltimos 50):"
	@docker logs bookly-api-gateway 2>&1 | grep "Path Traversal" | tail -50 || echo "No attacks detected"
	@echo ""
	@echo "üìä IPs m√°s activas en ataques:"
	@docker logs bookly-api-gateway 2>&1 | grep "Path Traversal" | grep -oP 'ip":\s*"\K[^"]+' | sort | uniq -c | sort -rn | head -10 || echo "No attacks detected"
	@echo ""
	@echo "üìä Patrones de ataque m√°s comunes:"
	@docker logs bookly-api-gateway 2>&1 | grep "Path Traversal" | grep -oP 'url":\s*"\K[^"]+' | sort | uniq -c | sort -rn | head -10 || echo "No attacks detected"

dev-fix-all: dev-fix-mongodb dev-fix-host-binding dev-fix-redis-stability dev-fix-rabbitmq-boot dev-fix-service-ports ## Aplicar todos los fixes
	@echo "‚úÖ Todos los fixes aplicados"

# =============================================================================
# SSL PARA QA - booklyapp.com
# =============================================================================

dev-ssl-generate: ## Generar certificados SSL autofirmados para QA
	@echo "üîê Generando certificados SSL para QA..."
	@chmod +x scripts/generate-ssl-certificates-qa.sh
	@./scripts/generate-ssl-certificates-qa.sh

dev-ssl-verify: ## Verificar certificados SSL
	@echo "üîç Verificando certificados SSL..."
	@openssl x509 -in nginx/ssl/booklyapp.com.crt -noout -text | grep -A 2 "Subject:"
	@openssl x509 -in nginx/ssl/booklyapp.com.crt -noout -dates
	@echo ""
	@echo "‚úÖ Certificados verificados"

dev-ssl-test: ## Probar conexi√≥n HTTPS
	@echo "üåê Probando conexi√≥n HTTPS a bookly.com..."
	@curl -k -I https://bookly.com || echo "‚ùå No se pudo conectar a bookly.com"
	@echo ""
	@curl -k -s https://bookly.com/nginx-health || echo "‚ùå Nginx health check fall√≥"

# =============================================================================
# GCP LOAD BALANCER
# =============================================================================

dev-setup-lb: ## Configurar Nginx para GCP Load Balancer
	@echo "üîß Configurando Nginx para Load Balancer..."
	@chmod +x scripts/setup-loadbalancer-nginx.sh
	@./scripts/setup-loadbalancer-nginx.sh

dev-test-lb: ## Probar configuraci√≥n con Load Balancer
	@echo "üß™ Probando configuraci√≥n con Load Balancer..."
	@echo ""
	@echo "üìã Health check local:"
	@curl -s http://localhost/health || echo "‚ùå Health check fall√≥"
	@echo ""
	@echo "üìã Nginx funcionando:"
	@docker ps | grep nginx
	@echo ""
	@echo "‚ö†Ô∏è  Para probar con Load Balancer:"
	@echo "   curl -I https://booklyapp.com"

dev-fix-lb-ssl: ## Corregir problema SSL (elimina puerto 443, usa solo LB)
	@echo "üîß Corrigiendo configuraci√≥n SSL para Load Balancer..."
	@chmod +x scripts/fix-lb-ssl-issue.sh
	@./scripts/fix-lb-ssl-issue.sh
