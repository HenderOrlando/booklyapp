name: API Gateway - Build and Deploy

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'bookly-mock/apps/api-gateway/**'
      - 'bookly-mock/libs/**'
      - 'ci-cd/bookly-mock/dockerfiles/Dockerfile.gateway'
      - '.github/workflows/api-gateway.yml'
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build:
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/build-and-push-image.yml
    with:
      service-name: api-gateway
      dockerfile-path: ci-cd/bookly-mock/dockerfiles/Dockerfile.gateway
      context-path: bookly-mock
      image-name: bookly-api-gateway

  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions: {}
    steps:
      - name: Deploy API Gateway via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            # Login to GitHub Container Registry
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Pull the latest image
            # Set image variables
            REGISTRY="ghcr.io/${{ github.repository_owner }}"
            TAG="${{ github.ref_name }}-${{ github.sha }}"
            IMAGE="$REGISTRY/bookly-api-gateway:$TAG"
            docker pull "$IMAGE"

            # Stop and remove existing container
            docker stop bookly-api-gateway || true
            docker rm bookly-api-gateway || true

            # Run the new container
            docker run -d \
              --name bookly-api-gateway \
              --restart unless-stopped \
              -p 3000:3000 \
              --network bookly-network \
              --env-file /opt/bookly/.env.api-gateway \
              "$IMAGE"

            # Clean up old images
            docker image prune -f
