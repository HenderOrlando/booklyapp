name: Manual SSH Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Entorno de despliegue'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      service:
        description: 'Servicio a desplegar (o "all" para todos)'
        required: true
        default: 'all'
        type: string

env:
  SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
  SSH_HOST: ${{ secrets.SSH_HOST }}
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

jobs:
  deploy:
    name: Deploy via SSH
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Validar secrets requeridos
        run: |
          if [ -z "${{ secrets.SSH_USERNAME }}" ]; then
            echo "âŒ Error: SSH_USERNAME secret no estÃ¡ configurado"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_HOST }}" ]; then
            echo "âŒ Error: SSH_HOST secret no estÃ¡ configurado"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "âŒ Error: SSH_PRIVATE_KEY secret no estÃ¡ configurado"
            exit 1
          fi
          echo "âœ… Todos los secrets estÃ¡n configurados"

      - name: Configurar SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Probar conexiÃ³n SSH
        run: |
          echo "ğŸ”— Probando conexiÃ³n SSH a ${{ secrets.SSH_HOST }}..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=30 \
            ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} \
            "echo 'âœ… ConexiÃ³n SSH exitosa desde GitHub Actions'"

      - name: Ejecutar despliegue
        run: |
          echo "ğŸš€ Desplegando servicio: ${{ github.event.inputs.service }}"
          echo "ğŸ“ Entorno: ${{ github.event.inputs.environment }}"
          
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << 'DEPLOY_SCRIPT'
          
          # Variables del despliegue
          SERVICE="${{ github.event.inputs.service }}"
          ENVIRONMENT="${{ github.event.inputs.environment }}"
          DEPLOY_DIR="/opt/bookly"
          
          echo "ğŸ“‚ Directorio de despliegue: $DEPLOY_DIR"
          cd $DEPLOY_DIR || { echo "âŒ No existe el directorio $DEPLOY_DIR"; exit 1; }
          
          # Actualizar cÃ³digo
          echo "ğŸ“¥ Actualizando repositorio..."
          git fetch origin
          git checkout main
          git pull origin main
          
          # Desplegar servicios
          if [ "$SERVICE" = "all" ]; then
            echo "ğŸ”„ Desplegando todos los servicios..."
            docker-compose -f docker-compose.$ENVIRONMENT.yml pull
            docker-compose -f docker-compose.$ENVIRONMENT.yml up -d --remove-orphans
          else
            echo "ğŸ”„ Desplegando servicio: $SERVICE..."
            docker-compose -f docker-compose.$ENVIRONMENT.yml pull $SERVICE
            docker-compose -f docker-compose.$ENVIRONMENT.yml up -d --no-deps $SERVICE
          fi
          
          # Verificar estado
          echo "ğŸ“Š Estado de los contenedores:"
          docker-compose -f docker-compose.$ENVIRONMENT.yml ps
          
          echo "âœ… Despliegue completado exitosamente"
          
          DEPLOY_SCRIPT

      - name: Limpiar credenciales SSH
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          echo "ğŸ§¹ Credenciales SSH limpiadas"

      - name: Resumen del despliegue
        run: |
          echo "## ğŸ“‹ Resumen del Despliegue" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ParÃ¡metro | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Entorno** | ${{ github.event.inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Servicio** | ${{ github.event.inputs.service }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Host** | ${{ secrets.SSH_HOST }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Usuario** | ${{ secrets.SSH_USERNAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Ejecutado por** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Fecha** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
